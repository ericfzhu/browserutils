import{g as T,i as U,u as N,a as _,b as v,r as V,c as L,d as O,e as R,s as m,f as I,v as $,m as H}from"./assets/storage-2gKbC4GU.js";const d={ACTIVE_TAB_ID:"activeTabId",ACTIVE_TAB_DOMAIN:"activeTabDomain",ACTIVE_TAB_START_TIME:"activeTabStartTime",IS_USER_IDLE:"isUserIdle"};let r=null,c=null,s=null,f=!1;async function w(){await chrome.storage.session.set({[d.ACTIVE_TAB_ID]:r,[d.ACTIVE_TAB_DOMAIN]:c,[d.ACTIVE_TAB_START_TIME]:s,[d.IS_USER_IDLE]:f})}async function S(){const t=await chrome.storage.session.get([d.ACTIVE_TAB_ID,d.ACTIVE_TAB_DOMAIN,d.ACTIVE_TAB_START_TIME,d.IS_USER_IDLE]);r=t[d.ACTIVE_TAB_ID]??null,c=t[d.ACTIVE_TAB_DOMAIN]??null,s=t[d.ACTIVE_TAB_START_TIME]??null,f=t[d.IS_USER_IDLE]??!1}async function W(){if(await S(),r&&s){try{const t=await chrome.tabs.get(r);if(t.active&&t.windowId){const e=await chrome.windows.get(t.windowId);if(e.focused&&e.state!=="minimized"){console.log("Recovered active session for:",c);return}}if(c&&s){const e=Math.round((Date.now()-s)/1e3);e>0&&await I(c,e)}}catch{if(c&&s){const t=Math.round((Date.now()-s)/1e3);t>0&&t<600&&await I(c,t)}}r=null,c=null,s=null,await w(),await m(void 0)}if(!f)try{const[t]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(t!=null&&t.url&&t.id){const e=await chrome.windows.get(t.windowId);e.focused&&e.state!=="minimized"&&await y(t.id,t.url)}}catch{}}chrome.runtime.onInstalled.addListener(async()=>{console.log("BrowserUtils extension installed"),await h(),await D()});(async()=>(await D(),await W()))();async function D(){const t=await T();if(t.idleThreshold>0){const e=Math.max(15,t.idleThreshold);chrome.idle.setDetectionInterval(e)}}chrome.idle.onStateChanged.addListener(async t=>{if((await T()).idleThreshold!==0){if(t==="active"){if(f&&(f=!1,await w(),r))try{const i=await chrome.tabs.get(r);i.url&&await y(r,i.url)}catch{try{const[i]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});i!=null&&i.url&&i.id&&await y(i.id,i.url)}catch{}}}else if(!f){if(r)try{if((await chrome.tabs.get(r)).audible)return}catch{}f=!0,await w(),await E()}}});chrome.runtime.onMessage.addListener((t,e,i)=>(q(t,e).then(i),!0));async function q(t,e){var i;switch(t.type){case"GET_STATS":return(i=t.payload)!=null&&i.date?O(t.payload.date):R();case"ADD_BLOCKED_SITE":{const a=await L(t.payload);return await h(),a}case"REMOVE_BLOCKED_SITE":return await V(t.payload.id),await h(),{success:!0};case"UPDATE_BLOCKED_SITE":return await v(t.payload),await h(),{success:!0};case"UNLOCK_SITE":return x(t.payload.id,t.payload.password);case"GET_BLOCKED_SITES":return _();case"GET_SETTINGS":return T();case"UPDATE_SETTINGS":{const a=await N(t.payload);return await h(),t.payload.idleThreshold!==void 0&&await D(),a}case"CHECK_SITE":return p(t.payload.url);case"CHECK_SITE_WITH_REDIRECT":{const a=await p(t.payload.url);return a.blocked&&a.site?{blocked:!0,redirectUrl:chrome.runtime.getURL(`blocked.html?site=${a.site.id}`)}:{blocked:!1}}case"INCREMENT_BLOCKED_ATTEMPT":return await U(t.payload.domain),{success:!0};case"HEARTBEAT":return await K(e),{success:!0};case"VISIBILITY_CHANGE":return await C(t.payload,e),{success:!0};case"CONTENT_SCRIPT_READY":return await P(t.payload,e),{success:!0};default:return{error:"Unknown message type"}}}async function K(t){var n;if(!((n=t==null?void 0:t.tab)!=null&&n.id)||!t.tab.url||!(await T()).trackingEnabled)return;await S();const i=t.tab.id,a=t.tab.url,o=g(a);if(!o||a.startsWith("chrome://")||a.startsWith("chrome-extension://"))return;const l=Date.now();if(r===i&&c&&s){const u=Math.round((l-s)/1e3);u>0&&(await I(c,u),s=l,await w())}else if((!r||!s)&&t.tab.active)try{const u=await chrome.windows.get(t.tab.windowId);u.focused&&u.state!=="minimized"&&(r=i,c=o,s=l,await w(),await m({domain:o,startTime:s,tabId:i}))}catch{}}async function C(t,e){var l;if(!((l=e==null?void 0:e.tab)!=null&&l.id)||!e.tab.url||!(await T()).trackingEnabled)return;await S();const a=e.tab.id,o=g(t.url);if(o){if(t.visible){if(e.tab.active&&!f)try{const n=await chrome.windows.get(e.tab.windowId);n.focused&&n.state!=="minimized"&&(r&&r!==a&&await E(),r!==a&&(r=a,c=o,s=Date.now(),await w(),await m({domain:o,startTime:s,tabId:a})))}catch{}}else if(r===a&&c&&s){const n=Math.round((Date.now()-s)/1e3);n>0&&await I(c,n),r=null,c=null,s=null,await w(),await m(void 0)}}}async function P(t,e){t.visible&&await C(t,e)}async function x(t,e){const a=(await _()).find(o=>o.id===t);if(!a)return{success:!1,error:"Site not found"};if(a.unlockType==="password"&&a.passwordHash){if(!e)return{success:!1,error:"Password required"};if(!await $(e,a.passwordHash))return{success:!1,error:"Invalid password"}}return a.unlockType==="timer"&&a.timerDuration&&(a.timerUnlockedUntil=Date.now()+a.timerDuration*60*1e3,await v(a)),await h(),{success:!0}}async function p(t){if(!(await T()).blockingEnabled)return{blocked:!1};const i=await _();for(const a of i)if(a.enabled&&H(t,a.pattern)){if(a.unlockType==="timer"&&a.timerUnlockedUntil&&Date.now()<a.timerUnlockedUntil)return{blocked:!1};if(a.unlockType==="schedule"&&a.schedule){const o=new Date,l=o.getDay(),n=`${o.getHours().toString().padStart(2,"0")}:${o.getMinutes().toString().padStart(2,"0")}`;return a.schedule.days.includes(l)&&n>=a.schedule.startTime&&n<=a.schedule.endTime?{blocked:!0,site:a}:{blocked:!1}}return{blocked:!0,site:a}}return{blocked:!1}}async function h(){const t=await T(),e=await _(),a=(await chrome.declarativeNetRequest.getDynamicRules()).map(n=>n.id);if(a.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:a}),!t.blockingEnabled)return;const o=[];let l=1;for(const n of e){if(!n.enabled||n.unlockType==="timer"&&n.timerUnlockedUntil&&Date.now()<n.timerUnlockedUntil)continue;if(n.unlockType==="schedule"&&n.schedule){const A=new Date,k=A.getDay(),b=`${A.getHours().toString().padStart(2,"0")}:${A.getMinutes().toString().padStart(2,"0")}`,B=n.schedule.days.includes(k),M=b>=n.schedule.startTime&&b<=n.schedule.endTime;if(!B||!M)continue}let u;n.pattern.startsWith("*.")?u=`||${n.pattern.slice(2)}`:u=`||${n.pattern}`,o.push({id:l++,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{extensionPath:`/blocked.html?site=${encodeURIComponent(n.id)}`}},condition:{urlFilter:u,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}})}o.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({addRules:o})}function g(t){try{return new URL(t).hostname}catch{return null}}async function E(){if(c&&s){const t=Math.round((Date.now()-s)/1e3);t>0&&await I(c,t)}r=null,c=null,s=null,await w(),await m(void 0)}async function y(t,e){if(!(await T()).trackingEnabled||f)return;const a=g(e);if(a&&!(e.startsWith("chrome://")||e.startsWith("chrome-extension://"))){try{const o=await chrome.tabs.get(t);if(o.windowId&&(await chrome.windows.get(o.windowId)).state==="minimized")return}catch{return}await E(),r=t,c=a,s=Date.now(),await w(),await m({domain:a,startTime:s,tabId:t})}}chrome.tabs.onActivated.addListener(async t=>{try{const e=await chrome.tabs.get(t.tabId);e.url&&await y(t.tabId,e.url)}catch{}});chrome.tabs.onUpdated.addListener(async(t,e,i)=>{e.status==="complete"&&i.active&&i.url&&await y(t,i.url)});chrome.tabs.onRemoved.addListener(async t=>{t===r&&await E()});chrome.windows.onFocusChanged.addListener(async t=>{if(t===chrome.windows.WINDOW_ID_NONE)await E();else try{const[e]=await chrome.tabs.query({active:!0,windowId:t});e!=null&&e.url&&e.id&&await y(e.id,e.url)}catch{}});chrome.alarms.create("saveSession",{periodInMinutes:1});chrome.alarms.create("cleanup",{periodInMinutes:60});chrome.alarms.onAlarm.addListener(async t=>{if(await S(),t.name==="saveSession"){if(!s){const e=await chrome.storage.session.get([d.ACTIVE_TAB_ID,d.ACTIVE_TAB_DOMAIN,d.ACTIVE_TAB_START_TIME]);if(e[d.ACTIVE_TAB_START_TIME]){const i=e[d.ACTIVE_TAB_ID];if(i)try{const a=await chrome.tabs.get(i);if(a.active&&a.windowId){const o=await chrome.windows.get(a.windowId);o.focused&&o.state!=="minimized"&&(r=i,c=e[d.ACTIVE_TAB_DOMAIN],s=e[d.ACTIVE_TAB_START_TIME])}}catch{}}}if(c&&s){const e=Math.round((Date.now()-s)/1e3);e>0&&(await I(c,e),s=Date.now(),await w())}await h()}if(t.name==="cleanup"){const e=await T(),i=await R(),a=new Date;a.setDate(a.getDate()-e.retentionDays);const o=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`,l={};for(const[n,u]of Object.entries(i))n>=o&&(l[n]=u);await chrome.storage.local.set({dailyStats:l})}});
