import{g as w,a as u,r as A,s as C,u as M,b as N,c as F,i as K,d as z,e as T,f as P,j as k,k as W,l as $,m as j,n as _,o as S,p as h,v as H,q,t as v,w as x}from"./assets/storage-qviMmoTj.js";const E={IS_USER_IDLE:"isUserIdle"};let c=!1;async function D(){await chrome.storage.session.set({[E.IS_USER_IDLE]:c})}async function R(){c=(await chrome.storage.session.get([E.IS_USER_IDLE]))[E.IS_USER_IDLE]??!1}async function G(){await R();const t=await u();for(const[a,i]of Object.entries(t)){const e=parseInt(a);try{const n=await chrome.tabs.get(e);if(n.active&&n.windowId&&(await chrome.windows.get(n.windowId)).state!=="minimized"){console.log("Recovered active session for:",i.domain);continue}await f(e)}catch{const n=Date.now()-i.startTime;n>0&&n<6e5&&await S({domain:i.domain,startTime:i.startTime,endTime:Date.now(),windowId:i.windowId}),await v(e)}}c||await L()}async function L(){if((await w()).trackingEnabled)try{const a=await chrome.windows.getAll({windowTypes:["normal"]});for(const i of a)if(i.state!=="minimized"&&i.id){const[e]=await chrome.tabs.query({active:!0,windowId:i.id});e!=null&&e.url&&e.id&&await y(e.id,e.url,i.id)}}catch{}}chrome.runtime.onInstalled.addListener(async()=>{console.log("BrowserUtils extension installed"),await l(),await p()});(async()=>(await p(),await G()))();async function p(){const t=await w();if(t.idleThreshold>0){const a=Math.max(15,t.idleThreshold);chrome.idle.setDetectionInterval(a)}}chrome.idle.onStateChanged.addListener(async t=>{if((await w()).idleThreshold!==0){if(t==="active")c&&(c=!1,await D(),await L());else if(!c){const i=await u();for(const[e]of Object.entries(i))try{if((await chrome.tabs.get(parseInt(e))).audible)return}catch{}c=!0,await D(),await X()}}});chrome.runtime.onMessage.addListener((t,a,i)=>(V(t,a).then(i),!0));async function V(t,a){var i;switch(t.type){case"GET_STATS":return(i=t.payload)!=null&&i.date?j(t.payload.date):_();case"ADD_BLOCKED_SITE":{const e=await $(t.payload);return await l(),e}case"REMOVE_BLOCKED_SITE":return await W(t.payload.id),await l(),{success:!0};case"UPDATE_BLOCKED_SITE":return await k(t.payload),await l(),{success:!0};case"UPDATE_BLOCKED_SITES":return await P(t.payload),await l(),{success:!0};case"UNLOCK_SITE":return Q(t.payload.id,t.payload.password);case"GET_BLOCKED_SITES":return T();case"GET_SETTINGS":return w();case"UPDATE_SETTINGS":{const e=await z(t.payload);return await l(),t.payload.idleThreshold!==void 0&&await p(),e}case"CHECK_SITE":return g(t.payload.url);case"CHECK_SITE_WITH_REDIRECT":{const e=await g(t.payload.url);return e.blocked&&e.site?{blocked:!0,redirectUrl:chrome.runtime.getURL(`blocked.html?site=${e.site.id}`)}:{blocked:!1}}case"INCREMENT_BLOCKED_ATTEMPT":return await K(t.payload.domain),{success:!0};case"GET_BLOCKED_SITE_FOLDERS":return F();case"ADD_BLOCKED_SITE_FOLDER":return N(t.payload);case"UPDATE_BLOCKED_SITE_FOLDER":return await M(t.payload),{success:!0};case"UPDATE_BLOCKED_SITE_FOLDERS":return await C(t.payload),{success:!0};case"REMOVE_BLOCKED_SITE_FOLDER":return await A(t.payload.id),await l(),{success:!0};case"HEARTBEAT":return await Y(a),{success:!0};case"VISIBILITY_CHANGE":return await O(t.payload,a),{success:!0};case"CONTENT_SCRIPT_READY":return await J(t.payload,a),{success:!0};default:return{error:"Unknown message type"}}}async function Y(t){var m;if(!((m=t==null?void 0:t.tab)!=null&&m.id)||!t.tab.url||!(await w()).trackingEnabled)return;const i=t.tab.id,e=t.tab.url,n=t.tab.windowId??0,o=b(e);if(!o||e.startsWith("chrome://")||e.startsWith("chrome-extension://"))return;const s=Date.now(),r=(await u())[i];if(r)Math.round((s-r.startTime)/1e3)>0&&(await S({domain:r.domain,startTime:r.startTime,endTime:s,windowId:r.windowId}),await h(i,{domain:r.domain,startTime:s,tabId:i,windowId:r.windowId}));else if(t.tab.active&&!c)try{(await chrome.windows.get(n)).state!=="minimized"&&await h(i,{domain:o,startTime:s,tabId:i,windowId:n})}catch{}}async function O(t,a){var s;if(!((s=a==null?void 0:a.tab)!=null&&s.id)||!a.tab.url||!(await w()).trackingEnabled)return;const e=a.tab.id,n=a.tab.windowId??0,o=b(t.url);if(o)if(t.visible){if(a.tab.active&&!c)try{(await chrome.windows.get(n)).state!=="minimized"&&((await u())[e]||await h(e,{domain:o,startTime:Date.now(),tabId:e,windowId:n}))}catch{}}else await f(e)}async function J(t,a){t.visible&&await O(t,a)}async function Q(t,a){const e=(await T()).find(n=>n.id===t);if(!e)return{success:!1,error:"Site not found"};if(e.unlockType==="password"&&e.passwordHash){if(!a)return{success:!1,error:"Password required"};if(!await H(a,e.passwordHash))return{success:!1,error:"Invalid password"}}return e.unlockType==="timer"&&e.timerDuration&&(e.timerUnlockedUntil=Date.now()+e.timerDuration*60*1e3,await k(e)),await l(),{success:!0}}async function g(t){if(!(await w()).blockingEnabled)return{blocked:!1};const i=await T();for(const e of i)if(e.enabled&&q(t,e.pattern)){if(e.unlockType==="timer"&&e.timerUnlockedUntil&&Date.now()<e.timerUnlockedUntil)return{blocked:!1};if(e.unlockType==="schedule"&&e.schedule){const n=new Date,o=n.getDay(),s=`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`;return e.schedule.days.includes(o)&&s>=e.schedule.startTime&&s<=e.schedule.endTime?{blocked:!0,site:e}:{blocked:!1}}return{blocked:!0,site:e}}return{blocked:!1}}async function l(){const t=await w(),a=await T(),e=(await chrome.declarativeNetRequest.getDynamicRules()).map(s=>s.id);if(e.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:e}),!t.blockingEnabled)return;const n=[];let o=1;for(const s of a){if(!s.enabled||s.unlockType==="timer"&&s.timerUnlockedUntil&&Date.now()<s.timerUnlockedUntil)continue;if(s.unlockType==="schedule"&&s.schedule){const r=new Date,m=r.getDay(),I=`${r.getHours().toString().padStart(2,"0")}:${r.getMinutes().toString().padStart(2,"0")}`,U=s.schedule.days.includes(m),B=I>=s.schedule.startTime&&I<=s.schedule.endTime;if(!U||!B)continue}let d;s.pattern.startsWith("*.")?d=`||${s.pattern.slice(2)}`:d=`||${s.pattern}`,n.push({id:o++,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{extensionPath:`/blocked.html?site=${encodeURIComponent(s.id)}`}},condition:{urlFilter:d,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}})}n.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({addRules:n})}function b(t){try{return new URL(t).hostname}catch{return null}}async function f(t){const a=await v(t);a&&a.startTime&&Math.round((Date.now()-a.startTime)/1e3)>0&&await S({domain:a.domain,startTime:a.startTime,endTime:Date.now(),windowId:a.windowId})}async function X(){const t=await u(),a=Date.now();for(const[,i]of Object.entries(t))i.startTime&&Math.round((a-i.startTime)/1e3)>0&&await S({domain:i.domain,startTime:i.startTime,endTime:a,windowId:i.windowId});await x()}async function y(t,a,i){if(!(await w()).trackingEnabled||c)return;const n=b(a);if(!n||a.startsWith("chrome://")||a.startsWith("chrome-extension://"))return;let o=i;if(!o)try{if(o=(await chrome.tabs.get(t)).windowId,o&&(await chrome.windows.get(o)).state==="minimized")return}catch{return}if(!o)return;const d=(await u())[t];if(d)if(d.domain!==n)await f(t);else return;await h(t,{domain:n,startTime:Date.now(),tabId:t,windowId:o})}chrome.tabs.onActivated.addListener(async t=>{if(!c)try{const a=await chrome.tabs.get(t.tabId),i=await u();for(const[e,n]of Object.entries(i))n.windowId===a.windowId&&parseInt(e)!==t.tabId&&await f(parseInt(e));a.url&&await y(t.tabId,a.url,a.windowId)}catch{}});chrome.tabs.onUpdated.addListener(async(t,a,i)=>{a.status==="complete"&&i.active&&i.url&&await y(t,i.url,i.windowId)});chrome.tabs.onRemoved.addListener(async t=>{await f(t)});chrome.windows.onFocusChanged.addListener(async t=>{if(t!==chrome.windows.WINDOW_ID_NONE&&!c)try{if((await chrome.windows.get(t)).state!=="minimized"){const[i]=await chrome.tabs.query({active:!0,windowId:t});i!=null&&i.url&&i.id&&await y(i.id,i.url,t)}}catch{}});async function Z(){const t=await u(),a=await chrome.windows.getAll({windowTypes:["normal"]}),i=new Set(a.filter(e=>e.state==="minimized").map(e=>e.id));for(const[e,n]of Object.entries(t))i.has(n.windowId)&&await f(parseInt(e))}chrome.alarms.create("saveSession",{periodInMinutes:1});chrome.alarms.create("cleanup",{periodInMinutes:60});chrome.alarms.create("checkMinimized",{periodInMinutes:.25});chrome.alarms.onAlarm.addListener(async t=>{if(await R(),t.name==="saveSession"){const a=await u(),i=Date.now();for(const[e,n]of Object.entries(a)){const o=parseInt(e);try{const s=await chrome.tabs.get(o);if(s.active&&s.windowId&&(await chrome.windows.get(s.windowId)).state!=="minimized"){Math.round((i-n.startTime)/1e3)>0&&(await S({domain:n.domain,startTime:n.startTime,endTime:i,windowId:n.windowId}),await h(o,{...n,startTime:i}));continue}await f(o)}catch{await f(o)}}await l()}if(t.name==="checkMinimized"&&await Z(),t.name==="cleanup"){const a=await w(),i=await _(),e=new Date;e.setDate(e.getDate()-a.retentionDays);const n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,o={};for(const[s,d]of Object.entries(i))s>=n&&(o[s]=d);await chrome.storage.local.set({dailyStats:o})}});
