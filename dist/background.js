import{g as l,a as u,c as b,r as F,u as k,b as K,d as v,s as P,e as z,f as H,i as Y,j as $,k as x,l as G,m as W,n as j,o as T,p as q,q as L,t as V,v as J,w as Q,x as R,y as h,z as I,A,B as X,C as O,D as Z}from"./assets/storage-ChbUDMRv.js";const D={IS_USER_IDLE:"isUserIdle"};let c=!1;async function _(){await chrome.storage.session.set({[D.IS_USER_IDLE]:c})}async function C(){c=(await chrome.storage.session.get([D.IS_USER_IDLE]))[D.IS_USER_IDLE]??!1}async function tt(){await C();const t=await u();for(const[i,a]of Object.entries(t)){const e=parseInt(i);try{const s=await chrome.tabs.get(e);if(s.active&&s.windowId&&(await chrome.windows.get(s.windowId)).state!=="minimized"){console.log("Recovered active session for:",a.domain);continue}await m(e)}catch{const s=Date.now()-a.startTime;s>0&&s<6e5&&await h({domain:a.domain,startTime:a.startTime,endTime:Date.now(),windowId:a.windowId}),await O(e)}}c||await U()}async function U(){if((await l()).trackingEnabled)try{const i=await chrome.windows.getAll({windowTypes:["normal"]});for(const a of i)if(a.state!=="minimized"&&a.id){const[e]=await chrome.tabs.query({active:!0,windowId:a.id});e!=null&&e.url&&e.id&&await p(e.id,e.url,a.id)}}catch{}}chrome.runtime.onInstalled.addListener(async()=>{console.log("BrowserUtils extension installed"),await w(),await E()});(async()=>(await E(),await tt()))();async function E(){const t=await l();if(t.idleThreshold>0){const i=Math.max(15,t.idleThreshold);chrome.idle.setDetectionInterval(i)}}chrome.idle.onStateChanged.addListener(async t=>{if((await l()).idleThreshold!==0){if(t==="active")c&&(c=!1,await _(),await U());else if(!c){const a=await u();for(const[e]of Object.entries(a))try{if((await chrome.tabs.get(parseInt(e))).audible)return}catch{}c=!0,await _(),await ot()}}});chrome.runtime.onMessage.addListener((t,i,a)=>(et(t,i).then(a),!0));async function et(t,i){var a;switch(t.type){case"GET_STATS":return(a=t.payload)!=null&&a.date?Q(t.payload.date):R();case"ADD_BLOCKED_SITE":{const e=await J(t.payload);return await w(),e}case"REMOVE_BLOCKED_SITE":return await V(t.payload.id),await w(),{success:!0};case"UPDATE_BLOCKED_SITE":return await L(t.payload),await w(),{success:!0};case"UPDATE_BLOCKED_SITES":return await q(t.payload),await w(),{success:!0};case"UNLOCK_SITE":return st(t.payload.id,t.payload.password);case"GET_BLOCKED_SITES":return T();case"GET_SETTINGS":return l();case"UPDATE_SETTINGS":{const e=await j(t.payload);return await w(),t.payload.idleThreshold!==void 0&&await E(),e}case"CHECK_SITE":return g(t.payload.url);case"CHECK_SITE_WITH_REDIRECT":{const e=await g(t.payload.url);if(e.blocked&&e.site)return{blocked:!0,redirectUrl:chrome.runtime.getURL(`blocked.html?site=${e.site.id}`)};const s=y(t.payload.url);if(s){const o=await b(s);if(o.exceeded&&o.limit)return{blocked:!0,redirectUrl:chrome.runtime.getURL(`blocked.html?type=limit&limitId=${o.limit.id}`)}}return{blocked:!1}}case"INCREMENT_BLOCKED_ATTEMPT":return await W(t.payload.domain),{success:!0};case"GET_BLOCKED_SITE_FOLDERS":return G();case"ADD_BLOCKED_SITE_FOLDER":return x(t.payload);case"UPDATE_BLOCKED_SITE_FOLDER":return await $(t.payload),{success:!0};case"UPDATE_BLOCKED_SITE_FOLDERS":return await Y(t.payload),{success:!0};case"REMOVE_BLOCKED_SITE_FOLDER":return await H(t.payload.id),await w(),{success:!0};case"HEARTBEAT":return await it(i),{success:!0};case"VISIBILITY_CHANGE":return await B(t.payload,i),{success:!0};case"CONTENT_SCRIPT_READY":return await at(t.payload,i),{success:!0};case"GET_DOMAIN_CATEGORIES":return z();case"SET_DOMAIN_CATEGORY":return await P(t.payload.domain,t.payload.category),{success:!0};case"GET_DAILY_LIMITS":return v();case"ADD_DAILY_LIMIT":return await K(t.payload);case"UPDATE_DAILY_LIMIT":return await k(t.payload),{success:!0};case"REMOVE_DAILY_LIMIT":return await F(t.payload.id),{success:!0};case"BYPASS_DAILY_LIMIT":return nt(t.payload.id,t.payload.password);case"CHECK_DAILY_LIMIT":{const e=y(t.payload.url);return e?b(e):{exceeded:!1,timeSpent:0,remaining:1/0}}default:return{error:"Unknown message type"}}}async function it(t){var f;if(!((f=t==null?void 0:t.tab)!=null&&f.id)||!t.tab.url||!(await l()).trackingEnabled)return;const a=t.tab.id,e=t.tab.url,s=t.tab.windowId??0,o=y(e);if(!o||e.startsWith("chrome://")||e.startsWith("chrome-extension://"))return;const n=Date.now(),r=(await u())[a];if(r)Math.round((n-r.startTime)/1e3)>0&&(await h({domain:r.domain,startTime:r.startTime,endTime:n,windowId:r.windowId}),await I(a,{domain:r.domain,startTime:n,tabId:a,windowId:r.windowId}));else if(t.tab.active&&!c)try{(await chrome.windows.get(s)).state!=="minimized"&&await I(a,{domain:o,startTime:n,tabId:a,windowId:s})}catch{}}async function B(t,i){var n;if(!((n=i==null?void 0:i.tab)!=null&&n.id)||!i.tab.url||!(await l()).trackingEnabled)return;const e=i.tab.id,s=i.tab.windowId??0,o=y(t.url);if(o)if(t.visible){if(i.tab.active&&!c)try{(await chrome.windows.get(s)).state!=="minimized"&&((await u())[e]||await I(e,{domain:o,startTime:Date.now(),tabId:e,windowId:s}))}catch{}}else await m(e)}async function at(t,i){t.visible&&await B(t,i)}async function st(t,i){const e=(await T()).find(s=>s.id===t);if(!e)return{success:!1,error:"Site not found"};if(e.unlockType==="password"&&e.passwordHash){if(!i)return{success:!1,error:"Password required"};if(!await A(i,e.passwordHash))return{success:!1,error:"Invalid password"}}return e.unlockType==="timer"&&e.timerDuration&&(e.timerUnlockedUntil=Date.now()+e.timerDuration*60*1e3,await L(e)),await w(),{success:!0}}async function nt(t,i){const e=(await v()).find(o=>o.id===t);if(!e)return{success:!1,error:"Limit not found"};if(e.bypassType==="none")return{success:!1,error:"This limit cannot be bypassed"};if(e.bypassType==="password"){if(!i)return{success:!1,error:"Password required"};if(!e.passwordHash)return{success:!1,error:"No password set for this limit"};if(!await A(i,e.passwordHash))return{success:!1,error:"Invalid password"}}const s=15*60*1e3;return e.bypassedUntil=Date.now()+s,await k(e),{success:!0}}async function g(t){if(!(await l()).blockingEnabled)return{blocked:!1};const a=await T();for(const e of a)if(e.enabled&&X(t,e.pattern)){if(e.unlockType==="timer"&&e.timerUnlockedUntil&&Date.now()<e.timerUnlockedUntil)return{blocked:!1};if(e.unlockType==="schedule"&&e.schedule){const s=new Date,o=s.getDay(),n=`${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}`;return e.schedule.days.includes(o)&&n>=e.schedule.startTime&&n<=e.schedule.endTime?{blocked:!0,site:e}:{blocked:!1}}return{blocked:!0,site:e}}return{blocked:!1}}async function w(){const t=await l(),i=await T(),e=(await chrome.declarativeNetRequest.getDynamicRules()).map(n=>n.id);if(e.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:e}),!t.blockingEnabled)return;const s=[];let o=1;for(const n of i){if(!n.enabled||n.unlockType==="timer"&&n.timerUnlockedUntil&&Date.now()<n.timerUnlockedUntil)continue;if(n.unlockType==="schedule"&&n.schedule){const r=new Date,f=r.getDay(),S=`${r.getHours().toString().padStart(2,"0")}:${r.getMinutes().toString().padStart(2,"0")}`,M=n.schedule.days.includes(f),N=S>=n.schedule.startTime&&S<=n.schedule.endTime;if(!M||!N)continue}let d;n.pattern.startsWith("*.")?d=`||${n.pattern.slice(2)}`:d=`||${n.pattern}`,s.push({id:o++,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{extensionPath:`/blocked.html?site=${encodeURIComponent(n.id)}`}},condition:{urlFilter:d,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}})}s.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({addRules:s})}function y(t){try{return new URL(t).hostname}catch{return null}}async function m(t){const i=await O(t);i&&i.startTime&&Math.round((Date.now()-i.startTime)/1e3)>0&&await h({domain:i.domain,startTime:i.startTime,endTime:Date.now(),windowId:i.windowId})}async function ot(){const t=await u(),i=Date.now();for(const[,a]of Object.entries(t))a.startTime&&Math.round((i-a.startTime)/1e3)>0&&await h({domain:a.domain,startTime:a.startTime,endTime:i,windowId:a.windowId});await Z()}async function p(t,i,a){if(!(await l()).trackingEnabled||c)return;const s=y(i);if(!s||i.startsWith("chrome://")||i.startsWith("chrome-extension://"))return;let o=a;if(!o)try{if(o=(await chrome.tabs.get(t)).windowId,o&&(await chrome.windows.get(o)).state==="minimized")return}catch{return}if(!o)return;const d=(await u())[t];if(d)if(d.domain!==s)await m(t);else return;await I(t,{domain:s,startTime:Date.now(),tabId:t,windowId:o})}chrome.tabs.onActivated.addListener(async t=>{if(!c)try{const i=await chrome.tabs.get(t.tabId),a=await u();for(const[e,s]of Object.entries(a))s.windowId===i.windowId&&parseInt(e)!==t.tabId&&await m(parseInt(e));i.url&&await p(t.tabId,i.url,i.windowId)}catch{}});chrome.tabs.onUpdated.addListener(async(t,i,a)=>{i.status==="complete"&&a.active&&a.url&&await p(t,a.url,a.windowId)});chrome.tabs.onRemoved.addListener(async t=>{await m(t)});chrome.windows.onFocusChanged.addListener(async t=>{if(t!==chrome.windows.WINDOW_ID_NONE&&!c)try{if((await chrome.windows.get(t)).state!=="minimized"){const[a]=await chrome.tabs.query({active:!0,windowId:t});a!=null&&a.url&&a.id&&await p(a.id,a.url,t)}}catch{}});async function rt(){const t=await u(),i=await chrome.windows.getAll({windowTypes:["normal"]}),a=new Set(i.filter(e=>e.state==="minimized").map(e=>e.id));for(const[e,s]of Object.entries(t))a.has(s.windowId)&&await m(parseInt(e))}chrome.alarms.create("saveSession",{periodInMinutes:1});chrome.alarms.create("cleanup",{periodInMinutes:60});chrome.alarms.create("checkMinimized",{periodInMinutes:.25});chrome.alarms.onAlarm.addListener(async t=>{if(await C(),t.name==="saveSession"){const i=await u(),a=Date.now();for(const[e,s]of Object.entries(i)){const o=parseInt(e);try{const n=await chrome.tabs.get(o);if(n.active&&n.windowId&&(await chrome.windows.get(n.windowId)).state!=="minimized"){Math.round((a-s.startTime)/1e3)>0&&(await h({domain:s.domain,startTime:s.startTime,endTime:a,windowId:s.windowId}),await I(o,{...s,startTime:a}));continue}await m(o)}catch{await m(o)}}await w()}if(t.name==="checkMinimized"&&await rt(),t.name==="cleanup"){const i=await l(),a=await R(),e=new Date;e.setDate(e.getDate()-i.retentionDays);const s=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,o={};for(const[n,d]of Object.entries(a))n>=s&&(o[n]=d);await chrome.storage.local.set({dailyStats:o})}});
