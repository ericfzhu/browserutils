import{g as T,u as R,a as E,b,r as C,c as k,d as B,e as g,s as m,f as I,v as M,m as U,i as V}from"./assets/storage-2gKbC4GU.js";const l={ACTIVE_TAB_ID:"activeTabId",ACTIVE_TAB_DOMAIN:"activeTabDomain",ACTIVE_TAB_START_TIME:"activeTabStartTime",IS_USER_IDLE:"isUserIdle"};let r=null,c=null,n=null,f=!1;async function w(){await chrome.storage.session.set({[l.ACTIVE_TAB_ID]:r,[l.ACTIVE_TAB_DOMAIN]:c,[l.ACTIVE_TAB_START_TIME]:n,[l.IS_USER_IDLE]:f})}async function S(){const t=await chrome.storage.session.get([l.ACTIVE_TAB_ID,l.ACTIVE_TAB_DOMAIN,l.ACTIVE_TAB_START_TIME,l.IS_USER_IDLE]);r=t[l.ACTIVE_TAB_ID]??null,c=t[l.ACTIVE_TAB_DOMAIN]??null,n=t[l.ACTIVE_TAB_START_TIME]??null,f=t[l.IS_USER_IDLE]??!1}async function N(){if(await S(),r&&n){try{const t=await chrome.tabs.get(r);if(t.active&&t.windowId){const e=await chrome.windows.get(t.windowId);if(e.focused&&e.state!=="minimized"){console.log("Recovered active session for:",c);return}}if(c&&n){const e=Math.round((Date.now()-n)/1e3);e>0&&await I(c,e)}}catch{if(c&&n){const t=Math.round((Date.now()-n)/1e3);t>0&&t<600&&await I(c,t)}}r=null,c=null,n=null,await w(),await m(void 0)}if(!f)try{const[t]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(t!=null&&t.url&&t.id){const e=await chrome.windows.get(t.windowId);e.focused&&e.state!=="minimized"&&await _(t.id,t.url)}}catch{}}chrome.runtime.onInstalled.addListener(async()=>{console.log("BrowserUtils extension installed"),await h(),await D()});(async()=>(await D(),await N()))();async function D(){const t=await T();if(t.idleThreshold>0){const e=Math.max(15,t.idleThreshold);chrome.idle.setDetectionInterval(e)}}chrome.idle.onStateChanged.addListener(async t=>{if((await T()).idleThreshold!==0){if(t==="active"){if(f&&(f=!1,await w(),r))try{const i=await chrome.tabs.get(r);i.url&&await _(r,i.url)}catch{try{const[i]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});i!=null&&i.url&&i.id&&await _(i.id,i.url)}catch{}}}else if(!f){if(r)try{if((await chrome.tabs.get(r)).audible)return}catch{}f=!0,await w(),await y()}}});chrome.runtime.onMessage.addListener((t,e,i)=>(L(t,e).then(i),!0));async function L(t,e){var i;switch(t.type){case"GET_STATS":return(i=t.payload)!=null&&i.date?B(t.payload.date):g();case"ADD_BLOCKED_SITE":{const a=await k(t.payload);return await h(),a}case"REMOVE_BLOCKED_SITE":return await C(t.payload.id),await h(),{success:!0};case"UPDATE_BLOCKED_SITE":return await b(t.payload),await h(),{success:!0};case"UNLOCK_SITE":return W(t.payload.id,t.payload.password);case"GET_BLOCKED_SITES":return E();case"GET_SETTINGS":return T();case"UPDATE_SETTINGS":{const a=await R(t.payload);return await h(),t.payload.idleThreshold!==void 0&&await D(),a}case"CHECK_SITE":return v(t.payload.url);case"HEARTBEAT":return await O(e),{success:!0};case"VISIBILITY_CHANGE":return await p(t.payload,e),{success:!0};case"CONTENT_SCRIPT_READY":return await q(t.payload,e),{success:!0};default:return{error:"Unknown message type"}}}async function O(t){var o;if(!((o=t==null?void 0:t.tab)!=null&&o.id)||!t.tab.url||!(await T()).trackingEnabled)return;await S();const i=t.tab.id,a=t.tab.url,s=A(a);if(!s||a.startsWith("chrome://")||a.startsWith("chrome-extension://"))return;const d=Date.now();if(r===i&&c&&n){const u=Math.round((d-n)/1e3);u>0&&(await I(c,u),n=d,await w())}else if((!r||!n)&&t.tab.active)try{const u=await chrome.windows.get(t.tab.windowId);u.focused&&u.state!=="minimized"&&(r=i,c=s,n=d,await w(),await m({domain:s,startTime:n,tabId:i}))}catch{}}async function p(t,e){var d;if(!((d=e==null?void 0:e.tab)!=null&&d.id)||!e.tab.url||!(await T()).trackingEnabled)return;await S();const a=e.tab.id,s=A(t.url);if(s){if(t.visible){if(e.tab.active&&!f)try{const o=await chrome.windows.get(e.tab.windowId);o.focused&&o.state!=="minimized"&&(r&&r!==a&&await y(),r!==a&&(r=a,c=s,n=Date.now(),await w(),await m({domain:s,startTime:n,tabId:a})))}catch{}}else if(r===a&&c&&n){const o=Math.round((Date.now()-n)/1e3);o>0&&await I(c,o),r=null,c=null,n=null,await w(),await m(void 0)}}}async function q(t,e){t.visible&&await p(t,e)}async function W(t,e){const a=(await E()).find(s=>s.id===t);if(!a)return{success:!1,error:"Site not found"};if(a.unlockType==="password"&&a.passwordHash){if(!e)return{success:!1,error:"Password required"};if(!await M(e,a.passwordHash))return{success:!1,error:"Invalid password"}}return a.unlockType==="timer"&&a.timerDuration&&(a.timerUnlockedUntil=Date.now()+a.timerDuration*60*1e3,await b(a)),await h(),{success:!0}}async function v(t){if(!(await T()).blockingEnabled)return{blocked:!1};const i=await E();for(const a of i)if(a.enabled&&U(t,a.pattern)){if(a.unlockType==="timer"&&a.timerUnlockedUntil&&Date.now()<a.timerUnlockedUntil)return{blocked:!1};if(a.unlockType==="schedule"&&a.schedule){const s=new Date,d=s.getDay(),o=`${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}`;return a.schedule.days.includes(d)&&o>=a.schedule.startTime&&o<=a.schedule.endTime?{blocked:!0,site:a}:{blocked:!1}}return{blocked:!0,site:a}}return{blocked:!1}}async function h(){const t=await T(),e=await E(),a=(await chrome.declarativeNetRequest.getDynamicRules()).map(o=>o.id);if(a.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:a}),!t.blockingEnabled)return;const s=[];let d=1;for(const o of e){if(!o.enabled||o.unlockType==="timer"&&o.timerUnlockedUntil&&Date.now()<o.timerUnlockedUntil)continue;let u;o.pattern.startsWith("*.")?u=`||${o.pattern.slice(2)}`:u=`||${o.pattern}`,s.push({id:d++,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{extensionPath:`/blocked.html?site=${encodeURIComponent(o.id)}`}},condition:{urlFilter:u,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}})}s.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({addRules:s})}function A(t){try{return new URL(t).hostname}catch{return null}}async function y(){if(c&&n){const t=Math.round((Date.now()-n)/1e3);t>0&&await I(c,t)}r=null,c=null,n=null,await w(),await m(void 0)}async function _(t,e){if(!(await T()).trackingEnabled||f)return;const a=A(e);if(a&&!(e.startsWith("chrome://")||e.startsWith("chrome-extension://"))){try{const s=await chrome.tabs.get(t);if(s.windowId&&(await chrome.windows.get(s.windowId)).state==="minimized")return}catch{return}await y(),r=t,c=a,n=Date.now(),await w(),await m({domain:a,startTime:n,tabId:t})}}chrome.tabs.onActivated.addListener(async t=>{try{const e=await chrome.tabs.get(t.tabId);e.url&&await _(t.tabId,e.url)}catch{}});chrome.tabs.onUpdated.addListener(async(t,e,i)=>{e.status==="complete"&&i.active&&i.url&&(await _(t,i.url),(await v(i.url)).blocked&&A(i.url)&&await V())});chrome.tabs.onRemoved.addListener(async t=>{t===r&&await y()});chrome.windows.onFocusChanged.addListener(async t=>{if(t===chrome.windows.WINDOW_ID_NONE)await y();else try{const[e]=await chrome.tabs.query({active:!0,windowId:t});e!=null&&e.url&&e.id&&await _(e.id,e.url)}catch{}});chrome.alarms.create("saveSession",{periodInMinutes:1});chrome.alarms.create("cleanup",{periodInMinutes:60});chrome.alarms.onAlarm.addListener(async t=>{if(await S(),t.name==="saveSession"){if(!n){const e=await chrome.storage.session.get([l.ACTIVE_TAB_ID,l.ACTIVE_TAB_DOMAIN,l.ACTIVE_TAB_START_TIME]);if(e[l.ACTIVE_TAB_START_TIME]){const i=e[l.ACTIVE_TAB_ID];if(i)try{const a=await chrome.tabs.get(i);if(a.active&&a.windowId){const s=await chrome.windows.get(a.windowId);s.focused&&s.state!=="minimized"&&(r=i,c=e[l.ACTIVE_TAB_DOMAIN],n=e[l.ACTIVE_TAB_START_TIME])}}catch{}}}if(c&&n){const e=Math.round((Date.now()-n)/1e3);e>0&&(await I(c,e),n=Date.now(),await w())}await h()}if(t.name==="cleanup"){const e=await T(),i=await g(),a=new Date;a.setDate(a.getDate()-e.retentionDays);const s=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`,d={};for(const[o,u]of Object.entries(i))o>=s&&(d[o]=u);await chrome.storage.local.set({dailyStats:d})}});
