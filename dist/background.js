import{m as j,g as f,b as k,d as b,v as N,e as C,r as $,u as F,f as q,i as K,s as J,j as Q,k as X,l as Z,n as tt,o as et,p as at,q as it,t as nt,w as E,x as O,y as st,z as ot,A as rt,B as G,C as ct,D as h,E as dt,F as R,G as lt,H as ut,I as wt,J as ft,K as mt,L as H,M as g,N as D,O as v,P as Tt,Q as ht,R as It,S as W,T as P}from"./assets/storage-DqX9mAL-.js";const T={IS_USER_IDLE:"isUserIdle",LOCKDOWN_AUTH_UNTIL:"lockdownAuthUntil"};let u=!1,_=null;const St=45e3;function B(t,a=Date.now()){return a-t.lastActiveTime<=St}async function m(){return _||(_=await b(),_)}async function Y(){await chrome.storage.session.set({[T.IS_USER_IDLE]:u})}async function x(){u=(await chrome.storage.session.get([T.IS_USER_IDLE]))[T.IS_USER_IDLE]??!1}const Et=5*60*1e3;async function bt(){const a=(await chrome.storage.session.get([T.LOCKDOWN_AUTH_UNTIL]))[T.LOCKDOWN_AUTH_UNTIL];return a?Date.now()<a:!1}async function yt(){const t=Date.now()+Et;return await chrome.storage.session.set({[T.LOCKDOWN_AUTH_UNTIL]:t}),t}async function pt(){await chrome.storage.session.remove([T.LOCKDOWN_AUTH_UNTIL])}async function _t(){return(await chrome.storage.session.get([T.LOCKDOWN_AUTH_UNTIL]))[T.LOCKDOWN_AUTH_UNTIL]}async function Dt(){await x();const t=await f();for(const[a,n]of Object.entries(t)){const e=parseInt(a);try{const i=await chrome.tabs.get(e);if(i.active&&i.windowId&&(await chrome.windows.get(i.windowId)).state!=="minimized"&&B(n)){console.log("Recovered active session for:",n.domain);continue}await w(e)}catch{const i=Date.now()-n.startTime;i>0&&i<6e5&&await g({domain:n.domain,startTime:n.startTime,endTime:Date.now(),windowId:n.windowId}),await P(e)}}u||await z()}async function z(){if((await m()).trackingEnabled)try{const a=await chrome.windows.getAll({windowTypes:["normal"]});for(const n of a)if(n.state!=="minimized"&&n.id){const[e]=await chrome.tabs.query({active:!0,windowId:n.id});e!=null&&e.url&&e.id&&await A(e.id,e.url,n.id)}}catch{}}chrome.runtime.onInstalled.addListener(async()=>{console.log("BrowserUtils extension installed/updated"),await l(),await M(),await j()});(async()=>(await m(),await M(),await Dt()))();async function M(){const t=await m();if(t.idleThreshold>0){const a=Math.max(15,t.idleThreshold);chrome.idle.setDetectionInterval(a)}}chrome.idle.onStateChanged.addListener(async t=>{if((await m()).idleThreshold!==0){if(t==="active")u&&(u=!1,await Y(),await z());else if(!u){const n=await f();for(const[e]of Object.entries(n))try{if((await chrome.tabs.get(parseInt(e))).audible)return}catch{}u=!0,await Y(),await Bt(),await Ct()}}});chrome.runtime.onMessage.addListener((t,a,n)=>(gt(t,a).then(n),!0));async function gt(t,a){var n;switch(t.type){case"GET_STATS":return(n=t.payload)!=null&&n.date?mt(t.payload.date):H();case"GET_STATS_SUMMARY":return ft();case"GET_SESSIONS_FOR_RANGE":return wt(t.payload.startDate,t.payload.endDate);case"ADD_BLOCKED_SITE":{const e=await ut(t.payload);return await l(),e}case"REMOVE_BLOCKED_SITE":return await lt(t.payload.id),await l(),{success:!0};case"UPDATE_BLOCKED_SITE":return await R(t.payload),await l(),{success:!0};case"UPDATE_BLOCKED_SITES":return await dt(t.payload),await l(),{success:!0};case"UNLOCK_SITE":return Lt(t.payload.id,t.payload.password);case"START_TIMER_BLOCK":return kt(t.payload.id,t.payload.durationMinutes);case"CLEAR_TIMER_BLOCK":return Nt(t.payload.id);case"GET_TIMER_STATUS":{const i=(await h()).find(d=>d.id===t.payload.id);if(!i)return{found:!1};const s=Date.now(),o=i.timerBlockedUntil?s<i.timerBlockedUntil:!1,c=o&&i.timerBlockedUntil?i.timerBlockedUntil-s:0;return{found:!0,isActive:o,blockedUntil:i.timerBlockedUntil,remainingMs:c,timerDuration:i.timerDuration}}case"GET_BLOCKED_SITES":return h();case"GET_SETTINGS":return m();case"UPDATE_SETTINGS":{const e=await ct(t.payload);return _=e,await l(),t.payload.idleThreshold!==void 0&&await M(),e}case"CHECK_SITE":return L(t.payload.url);case"CHECK_SITE_WITH_REDIRECT":{const e=await L(t.payload.url);if(e.blocked&&e.site)return{blocked:!0,redirectUrl:chrome.runtime.getURL(`blocked.html?site=${e.site.id}`)};const i=y(t.payload.url);if(i){const s=await C(i);if(s.exceeded&&s.limit)return{blocked:!0,redirectUrl:chrome.runtime.getURL(`blocked.html?type=limit&limitId=${s.limit.id}`)}}return{blocked:!1}}case"INCREMENT_BLOCKED_ATTEMPT":return await G(t.payload.domain),{success:!0};case"GET_BLOCKED_SITE_FOLDERS":return E();case"ADD_BLOCKED_SITE_FOLDER":return rt(t.payload);case"UPDATE_BLOCKED_SITE_FOLDER":return await O(t.payload),{success:!0};case"UPDATE_BLOCKED_SITE_FOLDERS":return await ot(t.payload),{success:!0};case"REMOVE_BLOCKED_SITE_FOLDER":return await st(t.payload.id),await l(),{success:!0};case"START_FOCUS_SESSION":{const i=(await E()).find(o=>o.id===t.payload.folderId);if(!i)return{success:!1,error:"Folder not found"};const s=Date.now()+t.payload.durationMinutes*60*1e3;return i.focusUntil=s,i.focusDuration=t.payload.durationMinutes,await O(i),await l(),{success:!0,focusUntil:s}}case"STOP_FOCUS_SESSION":{const i=(await E()).find(s=>s.id===t.payload.folderId);return i?(i.focusUntil=void 0,await O(i),await l(),{success:!0}):{success:!1,error:"Folder not found"}}case"GET_FOCUS_STATUS":{const i=(await E()).find(d=>d.id===t.payload.folderId);if(!i)return{found:!1};const s=Date.now(),o=i.focusUntil?s<i.focusUntil:!1,c=o&&i.focusUntil?i.focusUntil-s:0;return{found:!0,isActive:o,focusUntil:i.focusUntil,remainingMs:c,focusDuration:i.focusDuration}}case"HEARTBEAT":return await Ut(a),{success:!0};case"VISIBILITY_CHANGE":return await V(t.payload,a),{success:!0};case"CONTENT_SCRIPT_READY":return await At(t.payload,a),{success:!0};case"YOUTUBE_CHANNEL_UPDATE":return await Ot(t.payload,a),{success:!0};case"YOUTUBE_VISIBILITY_CHANGE":return await vt(t.payload,a),{success:!0};case"GET_DOMAIN_CATEGORIES":return nt();case"SET_DOMAIN_CATEGORY":return await it(t.payload.domain,t.payload.category),{success:!0};case"GET_CUSTOM_CATEGORIES":return at();case"ADD_CUSTOM_CATEGORY":return et(t.payload);case"UPDATE_CUSTOM_CATEGORY":return await tt(t.payload),{success:!0};case"UPDATE_CUSTOM_CATEGORIES":return await Z(t.payload),{success:!0};case"DELETE_CUSTOM_CATEGORY":return await X(t.payload.id),{success:!0};case"GET_BUILTIN_CATEGORY_OVERRIDES":return Q();case"SET_BUILTIN_CATEGORY_NAME":return await J(t.payload.id,t.payload.name),{success:!0};case"GET_DAILY_LIMITS":return K();case"ADD_DAILY_LIMIT":return await q(t.payload);case"UPDATE_DAILY_LIMIT":return await F(t.payload),{success:!0};case"REMOVE_DAILY_LIMIT":return await $(t.payload.id),{success:!0};case"BYPASS_DAILY_LIMIT":return Rt(t.payload.id,t.payload.password);case"CHECK_DAILY_LIMIT":{const e=y(t.payload.url);return e?C(e):{exceeded:!1,timeSpent:0,remaining:1/0}}case"LOCKDOWN_GET_STATUS":{const e=await b(),i=await bt(),s=await _t();return{lockdownEnabled:e.lockdownEnabled??!1,hasPassword:!!e.passwordHash,sessionValid:i,sessionExpiresAt:s}}case"LOCKDOWN_AUTHENTICATE":{const e=await b();return e.passwordHash?await N(t.payload.password,e.passwordHash)?{success:!0,expiresAt:await yt()}:{success:!1,error:"Invalid password"}:{success:!1,error:"No master password set"}}case"LOCKDOWN_CLEAR_SESSION":return await pt(),{success:!0};case"GET_ACTIVE_YOUTUBE_SESSIONS":return k();default:return{error:"Unknown message type"}}}async function Ut(t){var r;if(!((r=t==null?void 0:t.tab)!=null&&r.id)||!t.tab.url||!(await m()).trackingEnabled)return;const n=t.tab.id,e=t.tab.url,i=t.tab.windowId??0,s=y(e);if(!s||e.startsWith("chrome://")||e.startsWith("chrome-extension://"))return;const o=Date.now(),d=(await f())[n];if(d)Math.round((o-d.startTime)/1e3)>0&&(await g({domain:d.domain,startTime:d.startTime,endTime:o,windowId:d.windowId}),await D(n,{domain:d.domain,startTime:o,lastActiveTime:o,tabId:n,windowId:d.windowId}));else if(t.tab.active&&!u)try{(await chrome.windows.get(i)).state!=="minimized"&&await D(n,{domain:s,startTime:o,lastActiveTime:o,tabId:n,windowId:i})}catch{}}async function V(t,a){var o;if(!((o=a==null?void 0:a.tab)!=null&&o.id)||!a.tab.url||!(await m()).trackingEnabled)return;const e=a.tab.id,i=a.tab.windowId??0,s=y(t.url);if(s)if(t.visible){if(a.tab.active&&!u)try{if((await chrome.windows.get(i)).state!=="minimized"&&!(await f())[e]){const r=Date.now();await D(e,{domain:s,startTime:r,lastActiveTime:r,tabId:e,windowId:i})}}catch{}}else await w(e)}async function At(t,a){t.visible&&await V(t,a)}async function Ot(t,a){var d;if(console.log("[YouTube] Channel update received:",t),!((d=a==null?void 0:a.tab)!=null&&d.id)){console.log("[YouTube] No tab ID, ignoring");return}if(!(await b()).youtubeTrackingEnabled){console.log("[YouTube] Tracking disabled in settings");return}const e=a.tab.id,i=a.tab.windowId??0,s=Date.now(),c=(await k())[e];if(console.log("[YouTube] Existing session:",c),c){const r=c.channelName!==t.channelName,p=c.channelId&&t.channelId&&c.channelId!==t.channelId;r||p?(console.log("[YouTube] Channel changed, ending previous session"),await U(e),await v(e,{channelName:t.channelName,channelId:t.channelId,channelUrl:t.channelUrl,startTime:s,lastActiveTime:s,tabId:e,windowId:i}),console.log("[YouTube] Started new session for:",t.channelName)):(console.log("[YouTube] Same channel, updating lastActiveTime"),await v(e,{...c,lastActiveTime:s,channelId:t.channelId||c.channelId,channelUrl:t.channelUrl||c.channelUrl}));return}console.log("[YouTube] Starting new session for:",t.channelName),await v(e,{channelName:t.channelName,channelId:t.channelId,channelUrl:t.channelUrl,startTime:s,lastActiveTime:s,tabId:e,windowId:i})}async function vt(t,a){var i;if(console.log("[YouTube] Visibility change received:",t),!((i=a==null?void 0:a.tab)!=null&&i.id)){console.log("[YouTube] No tab ID, ignoring");return}if(!(await b()).youtubeTrackingEnabled){console.log("[YouTube] Tracking disabled in settings");return}const e=a.tab.id;t.visible||(console.log("[YouTube] Video paused/ended, ending session for tab:",e),await U(e))}async function U(t){const a=await Tt(t);if(console.log("[YouTube] Ending session:",a),a&&a.startTime){const n=Date.now(),e=a.lastActiveTime?a.lastActiveTime+3e4:n,i=Math.min(n,e),s=Math.round((i-a.startTime)/1e3);console.log("[YouTube] Session duration:",s,"seconds"),s>0?(await ht({channelName:a.channelName,channelId:a.channelId,channelUrl:a.channelUrl,startTime:a.startTime,endTime:i,windowId:a.windowId}),console.log("[YouTube] Session recorded for:",a.channelName)):console.log("[YouTube] Duration too short, not recording")}else console.log("[YouTube] No session to end")}async function Ct(){const t=await k();for(const[a]of Object.entries(t))await U(parseInt(a))}async function Lt(t,a){const e=(await h()).find(i=>i.id===t);if(!e)return{success:!1,error:"Site not found"};if(e.unlockType==="password"&&e.passwordHash){if(!a)return{success:!1,error:"Password required"};if(!await N(a,e.passwordHash))return{success:!1,error:"Invalid password"}}return await l(),{success:!0}}async function kt(t,a){const e=(await h()).find(o=>o.id===t);if(!e)return{success:!1,error:"Site not found"};if(e.unlockType!=="timer")return{success:!1,error:"Site does not use timer blocking"};const i=a??e.timerDuration??30,s=Date.now()+i*60*1e3;return e.timerBlockedUntil=s,await R(e),await l(),{success:!0,blockedUntil:s}}async function Nt(t){const n=(await h()).find(e=>e.id===t);return n?(n.timerBlockedUntil=void 0,await R(n),await l(),{success:!0}):{success:!1,error:"Site not found"}}async function Rt(t,a){const e=(await K()).find(s=>s.id===t);if(!e)return{success:!1,error:"Limit not found"};if(e.bypassType==="none")return{success:!1,error:"This limit cannot be bypassed"};if(e.bypassType==="password"){if(!a)return{success:!1,error:"Password required"};if(!e.passwordHash)return{success:!1,error:"No password set for this limit"};if(!await N(a,e.passwordHash))return{success:!1,error:"Invalid password"}}const i=15*60*1e3;return e.bypassedUntil=Date.now()+i,await F(e),{success:!0}}async function L(t){if(!(await m()).blockingEnabled)return{blocked:!1};const n=await h(),e=await E(),i=Date.now(),s=new Set;for(const o of e)o.focusUntil&&i<o.focusUntil&&s.add(o.id);for(const o of n)if(It(t,o.pattern)){if(o.folderId&&s.has(o.folderId))return{blocked:!0,site:o};if(!o.enabled)continue;return o.unlockType==="timer"?o.timerBlockedUntil&&i<o.timerBlockedUntil?{blocked:!0,site:o}:{blocked:!1}:o.unlockType==="schedule"&&o.schedule?W(o.schedule)?{blocked:!0,site:o}:{blocked:!1}:{blocked:!0,site:o}}return{blocked:!1}}async function l(){const t=await m(),a=await h(),n=await E(),e=Date.now(),s=(await chrome.declarativeNetRequest.getDynamicRules()).map(r=>r.id);if(s.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:s}),!t.blockingEnabled)return;const o=new Set;for(const r of n)r.focusUntil&&e<r.focusUntil&&o.add(r.id);const c=[];let d=1;for(const r of a){if(!(r.folderId&&o.has(r.folderId))&&(!r.enabled||r.unlockType==="timer"&&(!r.timerBlockedUntil||e>=r.timerBlockedUntil)||r.unlockType==="schedule"&&r.schedule&&!W(r.schedule)))continue;let I;if(r.pattern.includes("/")){let S=r.pattern;S.endsWith("/*")&&(S=S.slice(0,-2)+"*"),S.startsWith("*.")?I=`||${S.slice(2)}`:I=`||${S}`}else r.pattern.startsWith("*.")?I=`||${r.pattern.slice(2)}`:I=`||${r.pattern}`;c.push({id:d++,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{extensionPath:`/blocked.html?site=${encodeURIComponent(r.id)}`}},condition:{urlFilter:I,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}})}c.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({addRules:c})}function y(t){try{return new URL(t).hostname}catch{return null}}async function w(t){const a=await P(t);if(a&&a.startTime){const n=Date.now(),e=a.lastActiveTime?a.lastActiveTime+3e4:n,i=Math.min(n,e);Math.round((i-a.startTime)/1e3)>0&&await g({domain:a.domain,startTime:a.startTime,endTime:i,windowId:a.windowId})}}async function Bt(){const t=await f();for(const[a]of Object.entries(t))await w(parseInt(a))}async function A(t,a,n){if(!(await m()).trackingEnabled||u)return;const i=y(a);if(!i||a.startsWith("chrome://")||a.startsWith("chrome-extension://"))return;let s=n;if(!s)try{if(s=(await chrome.tabs.get(t)).windowId,s&&(await chrome.windows.get(s)).state==="minimized")return}catch{return}if(!s)return;const c=(await f())[t];if(c)if(c.domain!==i)await w(t);else return;const d=Date.now();await D(t,{domain:i,startTime:d,lastActiveTime:d,tabId:t,windowId:s})}chrome.tabs.onActivated.addListener(async t=>{if(!u)try{const a=await chrome.tabs.get(t.tabId),n=await f();for(const[e,i]of Object.entries(n))i.windowId===a.windowId&&parseInt(e)!==t.tabId&&await w(parseInt(e));a.url&&await A(t.tabId,a.url,a.windowId)}catch{}});chrome.tabs.onUpdated.addListener(async(t,a,n)=>{a.status==="complete"&&n.active&&n.url&&await A(t,n.url,n.windowId)});chrome.tabs.onRemoved.addListener(async t=>{await w(t),await U(t)});chrome.webNavigation.onBeforeNavigate.addListener(async t=>{if(t.frameId!==0||t.url.startsWith("chrome-extension://"))return;const a=await L(t.url);if(a.blocked&&a.site){await G(a.site.pattern);const e=chrome.runtime.getURL(`blocked.html?site=${a.site.id}`);chrome.tabs.update(t.tabId,{url:e});return}const n=y(t.url);if(n){const e=await C(n);if(e.exceeded&&e.limit){const i=chrome.runtime.getURL(`blocked.html?type=limit&limitId=${e.limit.id}`);chrome.tabs.update(t.tabId,{url:i})}}});chrome.windows.onFocusChanged.addListener(async t=>{if(!u){try{const a=await f();for(const[n,e]of Object.entries(a))try{(await chrome.windows.get(e.windowId)).state==="minimized"&&await w(parseInt(n))}catch{await w(parseInt(n))}}catch{}if(t!==chrome.windows.WINDOW_ID_NONE)try{if((await chrome.windows.get(t)).state!=="minimized"){const[n]=await chrome.tabs.query({active:!0,windowId:t});n!=null&&n.url&&n.id&&await A(n.id,n.url,t)}}catch{}}});async function Mt(){const t=Date.now(),a=await f(),n=await chrome.windows.getAll({windowTypes:["normal"]}),e=new Set(n.filter(i=>i.state==="minimized").map(i=>i.id));for(const[i,s]of Object.entries(a))(e.has(s.windowId)||!B(s,t))&&await w(parseInt(i))}chrome.alarms.create("saveSession",{periodInMinutes:1});chrome.alarms.create("cleanup",{periodInMinutes:60});chrome.alarms.create("checkMinimized",{periodInMinutes:.25});chrome.alarms.onAlarm.addListener(async t=>{if(await x(),t.name==="saveSession"){const a=await f(),n=Date.now();for(const[e,i]of Object.entries(a)){const s=parseInt(e);if(!B(i,n)){await w(s);continue}try{const o=await chrome.tabs.get(s);if(o.active&&o.windowId&&(await chrome.windows.get(o.windowId)).state!=="minimized"){const d=Math.min(n,i.lastActiveTime);Math.round((d-i.startTime)/1e3)>0&&(await g({domain:i.domain,startTime:i.startTime,endTime:d,windowId:i.windowId}),await D(s,{...i,startTime:d}));continue}await w(s)}catch{await w(s)}}await l()}if(t.name==="checkMinimized"&&await Mt(),t.name==="cleanup"){const a=await b(),n=await H(),e=new Date;e.setDate(e.getDate()-a.retentionDays);const i=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,s={};for(const[o,c]of Object.entries(n))o>=i&&(s[o]=c);await chrome.storage.local.set({dailyStats:s})}});
