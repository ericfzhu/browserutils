import{m as F,g as l,b as m,d as U,v as A,e as p,r as x,u as v,f as $,i as N,s as V,j as z,k as j,l as q,n as J,o as Q,p as X,q as Z,t as tt,w as et,x as at,y as it,z as nt,A as st,B as R,C as ot,D as h,E as rt,F as L,G as ct,H as dt,I as lt,J as ut,K as wt,L as B,M as E,N as b,O as D,P as ft,Q as Y,R as mt,S as Tt,T as M,U as ht}from"./assets/storage-BkZOJ9yk.js";const f={IS_USER_IDLE:"isUserIdle",LOCKDOWN_AUTH_UNTIL:"lockdownAuthUntil"};let u=!1;async function k(){await chrome.storage.session.set({[f.IS_USER_IDLE]:u})}async function K(){u=(await chrome.storage.session.get([f.IS_USER_IDLE]))[f.IS_USER_IDLE]??!1}const It=5*60*1e3;async function St(){const a=(await chrome.storage.session.get([f.LOCKDOWN_AUTH_UNTIL]))[f.LOCKDOWN_AUTH_UNTIL];return a?Date.now()<a:!1}async function bt(){const t=Date.now()+It;return await chrome.storage.session.set({[f.LOCKDOWN_AUTH_UNTIL]:t}),t}async function Et(){await chrome.storage.session.remove([f.LOCKDOWN_AUTH_UNTIL])}async function yt(){return(await chrome.storage.session.get([f.LOCKDOWN_AUTH_UNTIL]))[f.LOCKDOWN_AUTH_UNTIL]}async function gt(){await K();const t=await m();for(const[a,i]of Object.entries(t)){const e=parseInt(a);try{const n=await chrome.tabs.get(e);if(n.active&&n.windowId&&(await chrome.windows.get(n.windowId)).state!=="minimized"){console.log("Recovered active session for:",i.domain);continue}await T(e)}catch{const n=Date.now()-i.startTime;n>0&&n<6e5&&await E({domain:i.domain,startTime:i.startTime,endTime:Date.now(),windowId:i.windowId}),await M(e)}}u||await H()}async function H(){if((await l()).trackingEnabled)try{const a=await chrome.windows.getAll({windowTypes:["normal"]});for(const i of a)if(i.state!=="minimized"&&i.id){const[e]=await chrome.tabs.query({active:!0,windowId:i.id});e!=null&&e.url&&e.id&&await y(e.id,e.url,i.id)}}catch{}}chrome.runtime.onInstalled.addListener(async()=>{console.log("BrowserUtils extension installed/updated"),await w(),await C(),await F()});(async()=>(await C(),await gt()))();async function C(){const t=await l();if(t.idleThreshold>0){const a=Math.max(15,t.idleThreshold);chrome.idle.setDetectionInterval(a)}}chrome.idle.onStateChanged.addListener(async t=>{if((await l()).idleThreshold!==0){if(t==="active")u&&(u=!1,await k(),await H());else if(!u){const i=await m();for(const[e]of Object.entries(i))try{if((await chrome.tabs.get(parseInt(e))).audible)return}catch{}u=!0,await k(),await Nt(),await Lt()}}});chrome.runtime.onMessage.addListener((t,a,i)=>(Dt(t,a).then(i),!0));async function Dt(t,a){var i;switch(t.type){case"GET_STATS":return(i=t.payload)!=null&&i.date?wt(t.payload.date):B();case"GET_STATS_SUMMARY":return ut();case"GET_SESSIONS_FOR_RANGE":return lt(t.payload.startDate,t.payload.endDate);case"ADD_BLOCKED_SITE":{const e=await dt(t.payload);return await w(),e}case"REMOVE_BLOCKED_SITE":return await ct(t.payload.id),await w(),{success:!0};case"UPDATE_BLOCKED_SITE":return await L(t.payload),await w(),{success:!0};case"UPDATE_BLOCKED_SITES":return await rt(t.payload),await w(),{success:!0};case"UNLOCK_SITE":return Ct(t.payload.id,t.payload.password);case"START_TIMER_BLOCK":return Ot(t.payload.id,t.payload.durationMinutes);case"CLEAR_TIMER_BLOCK":return kt(t.payload.id);case"GET_TIMER_STATUS":{const n=(await h()).find(c=>c.id===t.payload.id);if(!n)return{found:!1};const s=Date.now(),o=n.timerBlockedUntil?s<n.timerBlockedUntil:!1,r=o&&n.timerBlockedUntil?n.timerBlockedUntil-s:0;return{found:!0,isActive:o,blockedUntil:n.timerBlockedUntil,remainingMs:r,timerDuration:n.timerDuration}}case"GET_BLOCKED_SITES":return h();case"GET_SETTINGS":return l();case"UPDATE_SETTINGS":{const e=await ot(t.payload);return await w(),t.payload.idleThreshold!==void 0&&await C(),e}case"CHECK_SITE":return _(t.payload.url);case"CHECK_SITE_WITH_REDIRECT":{const e=await _(t.payload.url);if(e.blocked&&e.site)return{blocked:!0,redirectUrl:chrome.runtime.getURL(`blocked.html?site=${e.site.id}`)};const n=I(t.payload.url);if(n){const s=await p(n);if(s.exceeded&&s.limit)return{blocked:!0,redirectUrl:chrome.runtime.getURL(`blocked.html?type=limit&limitId=${s.limit.id}`)}}return{blocked:!1}}case"INCREMENT_BLOCKED_ATTEMPT":return await R(t.payload.domain),{success:!0};case"GET_BLOCKED_SITE_FOLDERS":return st();case"ADD_BLOCKED_SITE_FOLDER":return nt(t.payload);case"UPDATE_BLOCKED_SITE_FOLDER":return await it(t.payload),{success:!0};case"UPDATE_BLOCKED_SITE_FOLDERS":return await at(t.payload),{success:!0};case"REMOVE_BLOCKED_SITE_FOLDER":return await et(t.payload.id),await w(),{success:!0};case"HEARTBEAT":return await pt(a),{success:!0};case"VISIBILITY_CHANGE":return await G(t.payload,a),{success:!0};case"CONTENT_SCRIPT_READY":return await _t(t.payload,a),{success:!0};case"YOUTUBE_CHANNEL_UPDATE":return await Ut(t.payload,a),{success:!0};case"YOUTUBE_VISIBILITY_CHANGE":return await At(t.payload,a),{success:!0};case"GET_DOMAIN_CATEGORIES":return tt();case"SET_DOMAIN_CATEGORY":return await Z(t.payload.domain,t.payload.category),{success:!0};case"GET_CUSTOM_CATEGORIES":return X();case"ADD_CUSTOM_CATEGORY":return Q(t.payload);case"UPDATE_CUSTOM_CATEGORY":return await J(t.payload),{success:!0};case"UPDATE_CUSTOM_CATEGORIES":return await q(t.payload),{success:!0};case"DELETE_CUSTOM_CATEGORY":return await j(t.payload.id),{success:!0};case"GET_BUILTIN_CATEGORY_OVERRIDES":return z();case"SET_BUILTIN_CATEGORY_NAME":return await V(t.payload.id,t.payload.name),{success:!0};case"GET_DAILY_LIMITS":return N();case"ADD_DAILY_LIMIT":return await $(t.payload);case"UPDATE_DAILY_LIMIT":return await v(t.payload),{success:!0};case"REMOVE_DAILY_LIMIT":return await x(t.payload.id),{success:!0};case"BYPASS_DAILY_LIMIT":return vt(t.payload.id,t.payload.password);case"CHECK_DAILY_LIMIT":{const e=I(t.payload.url);return e?p(e):{exceeded:!1,timeSpent:0,remaining:1/0}}case"LOCKDOWN_GET_STATUS":{const e=await l(),n=await St(),s=await yt();return{lockdownEnabled:e.lockdownEnabled??!1,hasPassword:!!e.passwordHash,sessionValid:n,sessionExpiresAt:s}}case"LOCKDOWN_AUTHENTICATE":{const e=await l();return e.passwordHash?await A(t.payload.password,e.passwordHash)?{success:!0,expiresAt:await bt()}:{success:!1,error:"Invalid password"}:{success:!1,error:"No master password set"}}case"LOCKDOWN_CLEAR_SESSION":return await Et(),{success:!0};case"GET_ACTIVE_YOUTUBE_SESSIONS":return U();default:return{error:"Unknown message type"}}}async function pt(t){var d;if(!((d=t==null?void 0:t.tab)!=null&&d.id)||!t.tab.url||!(await l()).trackingEnabled)return;const i=t.tab.id,e=t.tab.url,n=t.tab.windowId??0,s=I(e);if(!s||e.startsWith("chrome://")||e.startsWith("chrome-extension://"))return;const o=Date.now(),c=(await m())[i];if(c)Math.round((o-c.startTime)/1e3)>0&&(await E({domain:c.domain,startTime:c.startTime,endTime:o,windowId:c.windowId}),await b(i,{domain:c.domain,startTime:o,tabId:i,windowId:c.windowId}));else if(t.tab.active&&!u)try{(await chrome.windows.get(n)).state!=="minimized"&&await b(i,{domain:s,startTime:o,tabId:i,windowId:n})}catch{}}async function G(t,a){var o;if(!((o=a==null?void 0:a.tab)!=null&&o.id)||!a.tab.url||!(await l()).trackingEnabled)return;const e=a.tab.id,n=a.tab.windowId??0,s=I(t.url);if(s)if(t.visible){if(a.tab.active&&!u)try{(await chrome.windows.get(n)).state!=="minimized"&&((await m())[e]||await b(e,{domain:s,startTime:Date.now(),tabId:e,windowId:n}))}catch{}}else await T(e)}async function _t(t,a){t.visible&&await G(t,a)}async function Ut(t,a){var c;if(console.log("[YouTube] Channel update received:",t),!((c=a==null?void 0:a.tab)!=null&&c.id)){console.log("[YouTube] No tab ID, ignoring");return}if(!(await l()).youtubeTrackingEnabled){console.log("[YouTube] Tracking disabled in settings");return}const e=a.tab.id,n=a.tab.windowId??0,s=Date.now(),r=(await U())[e];if(console.log("[YouTube] Existing session:",r),r){const d=r.channelName!==t.channelName,S=r.channelId&&t.channelId&&r.channelId!==t.channelId;d||S?(console.log("[YouTube] Channel changed, ending previous session"),await O(e),await D(e,{channelName:t.channelName,channelId:t.channelId,channelUrl:t.channelUrl,startTime:s,tabId:e,windowId:n}),console.log("[YouTube] Started new session for:",t.channelName)):t.channelId&&!r.channelId||t.channelUrl&&!r.channelUrl?(console.log("[YouTube] Updating session with channelId/channelUrl:",t.channelId,t.channelUrl),await D(e,{...r,channelId:t.channelId||r.channelId,channelUrl:t.channelUrl||r.channelUrl})):console.log("[YouTube] Same channel, keeping session alive");return}console.log("[YouTube] Starting new session for:",t.channelName),await D(e,{channelName:t.channelName,channelId:t.channelId,channelUrl:t.channelUrl,startTime:s,tabId:e,windowId:n})}async function At(t,a){var n;if(console.log("[YouTube] Visibility change received:",t),!((n=a==null?void 0:a.tab)!=null&&n.id)){console.log("[YouTube] No tab ID, ignoring");return}if(!(await l()).youtubeTrackingEnabled){console.log("[YouTube] Tracking disabled in settings");return}const e=a.tab.id;t.visible||(console.log("[YouTube] Video paused/ended, ending session for tab:",e),await O(e))}async function O(t){const a=await ft(t);if(console.log("[YouTube] Ending session:",a),a&&a.startTime){const i=Math.round((Date.now()-a.startTime)/1e3);console.log("[YouTube] Session duration:",i,"seconds"),i>0?(await Y({channelName:a.channelName,channelId:a.channelId,channelUrl:a.channelUrl,startTime:a.startTime,endTime:Date.now(),windowId:a.windowId}),console.log("[YouTube] Session recorded for:",a.channelName)):console.log("[YouTube] Duration too short, not recording")}else console.log("[YouTube] No session to end")}async function Lt(){const t=await U(),a=Date.now();for(const[,i]of Object.entries(t))i.startTime&&Math.round((a-i.startTime)/1e3)>0&&await Y({channelName:i.channelName,channelId:i.channelId,channelUrl:i.channelUrl,startTime:i.startTime,endTime:a,windowId:i.windowId});await mt()}async function Ct(t,a){const e=(await h()).find(n=>n.id===t);if(!e)return{success:!1,error:"Site not found"};if(e.unlockType==="password"&&e.passwordHash){if(!a)return{success:!1,error:"Password required"};if(!await A(a,e.passwordHash))return{success:!1,error:"Invalid password"}}return await w(),{success:!0}}async function Ot(t,a){const e=(await h()).find(o=>o.id===t);if(!e)return{success:!1,error:"Site not found"};if(e.unlockType!=="timer")return{success:!1,error:"Site does not use timer blocking"};const n=a??e.timerDuration??30,s=Date.now()+n*60*1e3;return e.timerBlockedUntil=s,await L(e),await w(),{success:!0,blockedUntil:s}}async function kt(t){const i=(await h()).find(e=>e.id===t);return i?(i.timerBlockedUntil=void 0,await L(i),await w(),{success:!0}):{success:!1,error:"Site not found"}}async function vt(t,a){const e=(await N()).find(s=>s.id===t);if(!e)return{success:!1,error:"Limit not found"};if(e.bypassType==="none")return{success:!1,error:"This limit cannot be bypassed"};if(e.bypassType==="password"){if(!a)return{success:!1,error:"Password required"};if(!e.passwordHash)return{success:!1,error:"No password set for this limit"};if(!await A(a,e.passwordHash))return{success:!1,error:"Invalid password"}}const n=15*60*1e3;return e.bypassedUntil=Date.now()+n,await v(e),{success:!0}}async function _(t){if(!(await l()).blockingEnabled)return{blocked:!1};const i=await h();for(const e of i)if(e.enabled&&Tt(t,e.pattern)){if(e.unlockType==="timer")return e.timerBlockedUntil&&Date.now()<e.timerBlockedUntil?{blocked:!0,site:e}:{blocked:!1};if(e.unlockType==="schedule"&&e.schedule){const n=new Date,s=n.getDay(),o=`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`;return e.schedule.days.includes(s)&&o>=e.schedule.startTime&&o<=e.schedule.endTime?{blocked:!0,site:e}:{blocked:!1}}return{blocked:!0,site:e}}return{blocked:!1}}async function w(){const t=await l(),a=await h(),e=(await chrome.declarativeNetRequest.getDynamicRules()).map(o=>o.id);if(e.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:e}),!t.blockingEnabled)return;const n=[];let s=1;for(const o of a){if(!o.enabled||o.unlockType==="timer"&&(!o.timerBlockedUntil||Date.now()>=o.timerBlockedUntil))continue;if(o.unlockType==="schedule"&&o.schedule){const d=new Date,S=d.getDay(),g=`${d.getHours().toString().padStart(2,"0")}:${d.getMinutes().toString().padStart(2,"0")}`,W=o.schedule.days.includes(S),P=g>=o.schedule.startTime&&g<=o.schedule.endTime;if(!W||!P)continue}let r;if(o.pattern.includes("/")){let d=o.pattern;d.endsWith("/*")&&(d=d.slice(0,-2)+"*"),d.startsWith("*.")?r=`||${d.slice(2)}`:r=`||${d}`}else o.pattern.startsWith("*.")?r=`||${o.pattern.slice(2)}`:r=`||${o.pattern}`;n.push({id:s++,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{extensionPath:`/blocked.html?site=${encodeURIComponent(o.id)}`}},condition:{urlFilter:r,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}})}n.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({addRules:n})}function I(t){try{return new URL(t).hostname}catch{return null}}async function T(t){const a=await M(t);a&&a.startTime&&Math.round((Date.now()-a.startTime)/1e3)>0&&await E({domain:a.domain,startTime:a.startTime,endTime:Date.now(),windowId:a.windowId})}async function Nt(){const t=await m(),a=Date.now();for(const[,i]of Object.entries(t))i.startTime&&Math.round((a-i.startTime)/1e3)>0&&await E({domain:i.domain,startTime:i.startTime,endTime:a,windowId:i.windowId});await ht()}async function y(t,a,i){if(!(await l()).trackingEnabled||u)return;const n=I(a);if(!n||a.startsWith("chrome://")||a.startsWith("chrome-extension://"))return;let s=i;if(!s)try{if(s=(await chrome.tabs.get(t)).windowId,s&&(await chrome.windows.get(s)).state==="minimized")return}catch{return}if(!s)return;const r=(await m())[t];if(r)if(r.domain!==n)await T(t);else return;await b(t,{domain:n,startTime:Date.now(),tabId:t,windowId:s})}chrome.tabs.onActivated.addListener(async t=>{if(!u)try{const a=await chrome.tabs.get(t.tabId),i=await m();for(const[e,n]of Object.entries(i))n.windowId===a.windowId&&parseInt(e)!==t.tabId&&await T(parseInt(e));a.url&&await y(t.tabId,a.url,a.windowId)}catch{}});chrome.tabs.onUpdated.addListener(async(t,a,i)=>{a.status==="complete"&&i.active&&i.url&&await y(t,i.url,i.windowId)});chrome.tabs.onRemoved.addListener(async t=>{await T(t),await O(t)});chrome.webNavigation.onBeforeNavigate.addListener(async t=>{if(t.frameId!==0||t.url.startsWith("chrome-extension://"))return;const a=await _(t.url);if(a.blocked&&a.site){await R(a.site.pattern);const e=chrome.runtime.getURL(`blocked.html?site=${a.site.id}`);chrome.tabs.update(t.tabId,{url:e});return}const i=I(t.url);if(i){const e=await p(i);if(e.exceeded&&e.limit){const n=chrome.runtime.getURL(`blocked.html?type=limit&limitId=${e.limit.id}`);chrome.tabs.update(t.tabId,{url:n})}}});chrome.windows.onFocusChanged.addListener(async t=>{if(t!==chrome.windows.WINDOW_ID_NONE&&!u)try{if((await chrome.windows.get(t)).state!=="minimized"){const[i]=await chrome.tabs.query({active:!0,windowId:t});i!=null&&i.url&&i.id&&await y(i.id,i.url,t)}}catch{}});async function Rt(){const t=await m(),a=await chrome.windows.getAll({windowTypes:["normal"]}),i=new Set(a.filter(e=>e.state==="minimized").map(e=>e.id));for(const[e,n]of Object.entries(t))i.has(n.windowId)&&await T(parseInt(e))}chrome.alarms.create("saveSession",{periodInMinutes:1});chrome.alarms.create("cleanup",{periodInMinutes:60});chrome.alarms.create("checkMinimized",{periodInMinutes:.25});chrome.alarms.onAlarm.addListener(async t=>{if(await K(),t.name==="saveSession"){const a=await m(),i=Date.now();for(const[e,n]of Object.entries(a)){const s=parseInt(e);try{const o=await chrome.tabs.get(s);if(o.active&&o.windowId&&(await chrome.windows.get(o.windowId)).state!=="minimized"){Math.round((i-n.startTime)/1e3)>0&&(await E({domain:n.domain,startTime:n.startTime,endTime:i,windowId:n.windowId}),await b(s,{...n,startTime:i}));continue}await T(s)}catch{await T(s)}}await w()}if(t.name==="checkMinimized"&&await Rt(),t.name==="cleanup"){const a=await l(),i=await B(),e=new Date;e.setDate(e.getDate()-a.retentionDays);const n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,s={};for(const[o,r]of Object.entries(i))o>=n&&(s[o]=r);await chrome.storage.local.set({dailyStats:s})}});
