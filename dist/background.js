import{g as T,i as v,u as R,a as y,b,r as C,c as B,d as k,e as g,s as m,f as I,v as M,m as U}from"./assets/storage-2gKbC4GU.js";const d={ACTIVE_TAB_ID:"activeTabId",ACTIVE_TAB_DOMAIN:"activeTabDomain",ACTIVE_TAB_START_TIME:"activeTabStartTime",IS_USER_IDLE:"isUserIdle"};let r=null,c=null,n=null,f=!1;async function w(){await chrome.storage.session.set({[d.ACTIVE_TAB_ID]:r,[d.ACTIVE_TAB_DOMAIN]:c,[d.ACTIVE_TAB_START_TIME]:n,[d.IS_USER_IDLE]:f})}async function S(){const t=await chrome.storage.session.get([d.ACTIVE_TAB_ID,d.ACTIVE_TAB_DOMAIN,d.ACTIVE_TAB_START_TIME,d.IS_USER_IDLE]);r=t[d.ACTIVE_TAB_ID]??null,c=t[d.ACTIVE_TAB_DOMAIN]??null,n=t[d.ACTIVE_TAB_START_TIME]??null,f=t[d.IS_USER_IDLE]??!1}async function N(){if(await S(),r&&n){try{const t=await chrome.tabs.get(r);if(t.active&&t.windowId){const a=await chrome.windows.get(t.windowId);if(a.focused&&a.state!=="minimized"){console.log("Recovered active session for:",c);return}}if(c&&n){const a=Math.round((Date.now()-n)/1e3);a>0&&await I(c,a)}}catch{if(c&&n){const t=Math.round((Date.now()-n)/1e3);t>0&&t<600&&await I(c,t)}}r=null,c=null,n=null,await w(),await m(void 0)}if(!f)try{const[t]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(t!=null&&t.url&&t.id){const a=await chrome.windows.get(t.windowId);a.focused&&a.state!=="minimized"&&await _(t.id,t.url)}}catch{}}chrome.runtime.onInstalled.addListener(async()=>{console.log("BrowserUtils extension installed"),await h(),await A()});(async()=>(await A(),await N()))();async function A(){const t=await T();if(t.idleThreshold>0){const a=Math.max(15,t.idleThreshold);chrome.idle.setDetectionInterval(a)}}chrome.idle.onStateChanged.addListener(async t=>{if((await T()).idleThreshold!==0){if(t==="active"){if(f&&(f=!1,await w(),r))try{const i=await chrome.tabs.get(r);i.url&&await _(r,i.url)}catch{try{const[i]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});i!=null&&i.url&&i.id&&await _(i.id,i.url)}catch{}}}else if(!f){if(r)try{if((await chrome.tabs.get(r)).audible)return}catch{}f=!0,await w(),await E()}}});chrome.runtime.onMessage.addListener((t,a,i)=>(V(t,a).then(i),!0));async function V(t,a){var i;switch(t.type){case"GET_STATS":return(i=t.payload)!=null&&i.date?k(t.payload.date):g();case"ADD_BLOCKED_SITE":{const e=await B(t.payload);return await h(),e}case"REMOVE_BLOCKED_SITE":return await C(t.payload.id),await h(),{success:!0};case"UPDATE_BLOCKED_SITE":return await b(t.payload),await h(),{success:!0};case"UNLOCK_SITE":return q(t.payload.id,t.payload.password);case"GET_BLOCKED_SITES":return y();case"GET_SETTINGS":return T();case"UPDATE_SETTINGS":{const e=await R(t.payload);return await h(),t.payload.idleThreshold!==void 0&&await A(),e}case"CHECK_SITE":return W(t.payload.url);case"INCREMENT_BLOCKED_ATTEMPT":return await v(t.payload.domain),{success:!0};case"HEARTBEAT":return await L(a),{success:!0};case"VISIBILITY_CHANGE":return await p(t.payload,a),{success:!0};case"CONTENT_SCRIPT_READY":return await O(t.payload,a),{success:!0};default:return{error:"Unknown message type"}}}async function L(t){var o;if(!((o=t==null?void 0:t.tab)!=null&&o.id)||!t.tab.url||!(await T()).trackingEnabled)return;await S();const i=t.tab.id,e=t.tab.url,s=D(e);if(!s||e.startsWith("chrome://")||e.startsWith("chrome-extension://"))return;const l=Date.now();if(r===i&&c&&n){const u=Math.round((l-n)/1e3);u>0&&(await I(c,u),n=l,await w())}else if((!r||!n)&&t.tab.active)try{const u=await chrome.windows.get(t.tab.windowId);u.focused&&u.state!=="minimized"&&(r=i,c=s,n=l,await w(),await m({domain:s,startTime:n,tabId:i}))}catch{}}async function p(t,a){var l;if(!((l=a==null?void 0:a.tab)!=null&&l.id)||!a.tab.url||!(await T()).trackingEnabled)return;await S();const e=a.tab.id,s=D(t.url);if(s){if(t.visible){if(a.tab.active&&!f)try{const o=await chrome.windows.get(a.tab.windowId);o.focused&&o.state!=="minimized"&&(r&&r!==e&&await E(),r!==e&&(r=e,c=s,n=Date.now(),await w(),await m({domain:s,startTime:n,tabId:e})))}catch{}}else if(r===e&&c&&n){const o=Math.round((Date.now()-n)/1e3);o>0&&await I(c,o),r=null,c=null,n=null,await w(),await m(void 0)}}}async function O(t,a){t.visible&&await p(t,a)}async function q(t,a){const e=(await y()).find(s=>s.id===t);if(!e)return{success:!1,error:"Site not found"};if(e.unlockType==="password"&&e.passwordHash){if(!a)return{success:!1,error:"Password required"};if(!await M(a,e.passwordHash))return{success:!1,error:"Invalid password"}}return e.unlockType==="timer"&&e.timerDuration&&(e.timerUnlockedUntil=Date.now()+e.timerDuration*60*1e3,await b(e)),await h(),{success:!0}}async function W(t){if(!(await T()).blockingEnabled)return{blocked:!1};const i=await y();for(const e of i)if(e.enabled&&U(t,e.pattern)){if(e.unlockType==="timer"&&e.timerUnlockedUntil&&Date.now()<e.timerUnlockedUntil)return{blocked:!1};if(e.unlockType==="schedule"&&e.schedule){const s=new Date,l=s.getDay(),o=`${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}`;return e.schedule.days.includes(l)&&o>=e.schedule.startTime&&o<=e.schedule.endTime?{blocked:!0,site:e}:{blocked:!1}}return{blocked:!0,site:e}}return{blocked:!1}}async function h(){const t=await T(),a=await y(),e=(await chrome.declarativeNetRequest.getDynamicRules()).map(o=>o.id);if(e.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:e}),!t.blockingEnabled)return;const s=[];let l=1;for(const o of a){if(!o.enabled||o.unlockType==="timer"&&o.timerUnlockedUntil&&Date.now()<o.timerUnlockedUntil)continue;let u;o.pattern.startsWith("*.")?u=`||${o.pattern.slice(2)}`:u=`||${o.pattern}`,s.push({id:l++,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{extensionPath:`/blocked.html?site=${encodeURIComponent(o.id)}`}},condition:{urlFilter:u,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}})}s.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({addRules:s})}function D(t){try{return new URL(t).hostname}catch{return null}}async function E(){if(c&&n){const t=Math.round((Date.now()-n)/1e3);t>0&&await I(c,t)}r=null,c=null,n=null,await w(),await m(void 0)}async function _(t,a){if(!(await T()).trackingEnabled||f)return;const e=D(a);if(e&&!(a.startsWith("chrome://")||a.startsWith("chrome-extension://"))){try{const s=await chrome.tabs.get(t);if(s.windowId&&(await chrome.windows.get(s.windowId)).state==="minimized")return}catch{return}await E(),r=t,c=e,n=Date.now(),await w(),await m({domain:e,startTime:n,tabId:t})}}chrome.tabs.onActivated.addListener(async t=>{try{const a=await chrome.tabs.get(t.tabId);a.url&&await _(t.tabId,a.url)}catch{}});chrome.tabs.onUpdated.addListener(async(t,a,i)=>{a.status==="complete"&&i.active&&i.url&&await _(t,i.url)});chrome.tabs.onRemoved.addListener(async t=>{t===r&&await E()});chrome.windows.onFocusChanged.addListener(async t=>{if(t===chrome.windows.WINDOW_ID_NONE)await E();else try{const[a]=await chrome.tabs.query({active:!0,windowId:t});a!=null&&a.url&&a.id&&await _(a.id,a.url)}catch{}});chrome.alarms.create("saveSession",{periodInMinutes:1});chrome.alarms.create("cleanup",{periodInMinutes:60});chrome.alarms.onAlarm.addListener(async t=>{if(await S(),t.name==="saveSession"){if(!n){const a=await chrome.storage.session.get([d.ACTIVE_TAB_ID,d.ACTIVE_TAB_DOMAIN,d.ACTIVE_TAB_START_TIME]);if(a[d.ACTIVE_TAB_START_TIME]){const i=a[d.ACTIVE_TAB_ID];if(i)try{const e=await chrome.tabs.get(i);if(e.active&&e.windowId){const s=await chrome.windows.get(e.windowId);s.focused&&s.state!=="minimized"&&(r=i,c=a[d.ACTIVE_TAB_DOMAIN],n=a[d.ACTIVE_TAB_START_TIME])}}catch{}}}if(c&&n){const a=Math.round((Date.now()-n)/1e3);a>0&&(await I(c,a),n=Date.now(),await w())}await h()}if(t.name==="cleanup"){const a=await T(),i=await g(),e=new Date;e.setDate(e.getDate()-a.retentionDays);const s=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,l={};for(const[o,u]of Object.entries(i))o>=s&&(l[o]=u);await chrome.storage.local.set({dailyStats:l})}});
