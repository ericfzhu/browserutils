import{g as l,u as E,a as h,b as S,r as v,c as I,d as R,e as T,v as U,m as _,s as D,i as L,f as g}from"./assets/storage-CJbTCkcX.js";let d=null,u=null,r=null,w=!1;chrome.runtime.onInstalled.addListener(async()=>{console.log("BrowserUtils extension installed"),await c(),await p()});p();async function p(){const t=await l();if(t.idleThreshold>0){const e=Math.max(15,t.idleThreshold);chrome.idle.setDetectionInterval(e)}}chrome.idle.onStateChanged.addListener(async t=>{if((await l()).idleThreshold!==0)if(t==="active"){if(w&&(w=!1,d))try{const i=await chrome.tabs.get(d);i.url&&await y(d,i.url)}catch{}}else w||(w=!0,await m())});chrome.runtime.onMessage.addListener((t,e,i)=>(A(t).then(i),!0));async function A(t){var e;switch(t.type){case"GET_STATS":return(e=t.payload)!=null&&e.date?R(t.payload.date):T();case"ADD_BLOCKED_SITE":{const i=await I(t.payload);return await c(),i}case"REMOVE_BLOCKED_SITE":return await v(t.payload.id),await c(),{success:!0};case"UPDATE_BLOCKED_SITE":return await S(t.payload),await c(),{success:!0};case"UNLOCK_SITE":return B(t.payload.id,t.payload.password);case"GET_BLOCKED_SITES":return h();case"GET_SETTINGS":return l();case"UPDATE_SETTINGS":{const i=await E(t.payload);return await c(),t.payload.idleThreshold!==void 0&&await p(),i}case"CHECK_SITE":return k(t.payload.url);default:return{error:"Unknown message type"}}}async function B(t,e){const a=(await h()).find(n=>n.id===t);if(!a)return{success:!1,error:"Site not found"};if(a.unlockType==="password"&&a.passwordHash){if(!e)return{success:!1,error:"Password required"};if(!await U(e,a.passwordHash))return{success:!1,error:"Invalid password"}}return a.unlockType==="timer"&&a.timerDuration&&(a.timerUnlockedUntil=Date.now()+a.timerDuration*60*1e3,await S(a)),await c(),{success:!0}}async function k(t){if(!(await l()).blockingEnabled)return{blocked:!1};const i=await h();for(const a of i)if(a.enabled&&_(t,a.pattern)){if(a.unlockType==="timer"&&a.timerUnlockedUntil&&Date.now()<a.timerUnlockedUntil)return{blocked:!1};if(a.unlockType==="schedule"&&a.schedule){const n=new Date,o=n.getDay(),s=`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`;return a.schedule.days.includes(o)&&s>=a.schedule.startTime&&s<=a.schedule.endTime?{blocked:!0,site:a}:{blocked:!1}}return{blocked:!0,site:a}}return{blocked:!1}}async function c(){const t=await l(),e=await h(),a=(await chrome.declarativeNetRequest.getDynamicRules()).map(s=>s.id);if(a.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:a}),!t.blockingEnabled)return;const n=[];let o=1;for(const s of e){if(!s.enabled||s.unlockType==="timer"&&s.timerUnlockedUntil&&Date.now()<s.timerUnlockedUntil)continue;let f;s.pattern.startsWith("*.")?f=`||${s.pattern.slice(2)}`:f=`||${s.pattern}`,n.push({id:o++,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{extensionPath:`/blocked.html?site=${encodeURIComponent(s.id)}`}},condition:{urlFilter:f,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}})}n.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({addRules:n})}function b(t){try{return new URL(t).hostname}catch{return null}}async function m(){if(u&&r){const t=Math.round((Date.now()-r)/1e3);t>0&&await g(u,t)}d=null,u=null,r=null,await D(void 0)}async function y(t,e){if(!(await l()).trackingEnabled||w)return;const a=b(e);if(a&&!(e.startsWith("chrome://")||e.startsWith("chrome-extension://"))){try{const n=await chrome.tabs.get(t);if(n.windowId&&(await chrome.windows.get(n.windowId)).state==="minimized")return}catch{return}await m(),d=t,u=a,r=Date.now(),await D({domain:a,startTime:r,tabId:t})}}chrome.tabs.onActivated.addListener(async t=>{try{const e=await chrome.tabs.get(t.tabId);e.url&&await y(t.tabId,e.url)}catch{}});chrome.tabs.onUpdated.addListener(async(t,e,i)=>{e.status==="complete"&&i.active&&i.url&&(await y(t,i.url),(await k(i.url)).blocked&&b(i.url)&&await L())});chrome.tabs.onRemoved.addListener(async t=>{t===d&&await m()});chrome.windows.onFocusChanged.addListener(async t=>{if(t===chrome.windows.WINDOW_ID_NONE)await m();else try{const[e]=await chrome.tabs.query({active:!0,windowId:t});e!=null&&e.url&&e.id&&await y(e.id,e.url)}catch{}});chrome.alarms.create("saveSession",{periodInMinutes:1});chrome.alarms.create("cleanup",{periodInMinutes:60});chrome.alarms.onAlarm.addListener(async t=>{if(t.name==="saveSession"){if(u&&r){const e=Math.round((Date.now()-r)/1e3);e>0&&(await g(u,e),r=Date.now())}await c()}if(t.name==="cleanup"){const e=await l(),i=await T(),a=new Date;a.setDate(a.getDate()-e.retentionDays);const n=a.toISOString().split("T")[0],o={};for(const[s,f]of Object.entries(i))s>=n&&(o[s]=f);await chrome.storage.local.set({dailyStats:o})}});
