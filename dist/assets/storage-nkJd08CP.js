const v={trackingEnabled:!0,blockingEnabled:!0,youtubeTrackingEnabled:!1,theme:"system",retentionDays:30,idleThreshold:60,displayName:"",quickLinks:[]},i={BLOCKED_SITES:"blockedSites",BLOCKED_SITE_FOLDERS:"blockedSiteFolders",SETTINGS:"settings",DAILY_STATS:"dailyStats",ACTIVE_SESSIONS:"activeSessions",ACTIVE_YOUTUBE_SESSIONS:"activeYouTubeSessions",DOMAIN_CATEGORIES:"domainCategories",DAILY_LIMITS:"dailyLimits",CUSTOM_CATEGORIES:"customCategories",BUILTIN_CATEGORY_OVERRIDES:"builtInCategoryOverrides"};async function y(){return(await chrome.storage.local.get(i.BLOCKED_SITES))[i.BLOCKED_SITES]||[]}async function g(t){await chrome.storage.local.set({[i.BLOCKED_SITES]:t})}async function G(t){const e=await y(),s={...t,id:crypto.randomUUID(),createdAt:Date.now()};return e.push(s),await g(e),s}async function F(t){const s=(await y()).filter(n=>n.id!==t);await g(s)}async function x(t){const e=await y(),s=e.findIndex(n=>n.id===t.id);s!==-1&&(e[s]=t,await g(e))}async function I(){return(await chrome.storage.local.get(i.BLOCKED_SITE_FOLDERS))[i.BLOCKED_SITE_FOLDERS]||[]}async function E(t){await chrome.storage.local.set({[i.BLOCKED_SITE_FOLDERS]:t})}async function V(t){const e=await I(),s={...t,id:crypto.randomUUID()};return e.push(s),await E(e),s}async function j(t){const e=await I(),s=e.findIndex(n=>n.id===t.id);s!==-1&&(e[s]=t,await E(e))}async function K(t){const s=(await I()).filter(a=>a.id!==t);await E(s);const o=(await y()).map(a=>a.folderId===t?{...a,folderId:void 0}:a);await g(o)}async function N(){const t=await chrome.storage.local.get(i.SETTINGS);return{...v,...t[i.SETTINGS]}}async function W(t){const s={...await N(),...t};return await chrome.storage.local.set({[i.SETTINGS]:s}),s}function f(t=new Date){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}async function O(t){const e=t||f(),o=((await chrome.storage.local.get(i.DAILY_STATS))[i.DAILY_STATS]||{})[e];return o?((!o.sessions||Array.isArray(o.sessions))&&(o.sessions={}),(!o.youtubeSessions||Array.isArray(o.youtubeSessions))&&(o.youtubeSessions={}),o):{date:e,totalTime:0,sites:{},visits:0,blockedAttempts:0,sessions:{},youtubeSessions:{}}}async function P(){return(await chrome.storage.local.get(i.DAILY_STATS))[i.DAILY_STATS]||{}}async function H(){const e=(await chrome.storage.local.get(i.DAILY_STATS))[i.DAILY_STATS]||{},s={};for(const[n,o]of Object.entries(e))s[n]={date:o.date,totalTime:o.totalTime,sites:o.sites,visits:o.visits,blockedAttempts:o.blockedAttempts};return s}async function $(t,e){const n=(await chrome.storage.local.get(i.DAILY_STATS))[i.DAILY_STATS]||{},o=[],a=[];let c=new Date(t+"T00:00:00");const r=new Date(e+"T00:00:00");for(;c<=r;){const l=f(c),u=n[l];if(u){if(u.sessions&&typeof u.sessions=="object"&&!Array.isArray(u.sessions))for(const[S,d]of Object.entries(u.sessions))for(const[m,h]of d)o.push({domain:S,startTime:m*1e3,endTime:h*1e3,windowId:0});if(u.youtubeSessions&&typeof u.youtubeSessions=="object"&&!Array.isArray(u.youtubeSessions))for(const[S,d]of Object.entries(u.youtubeSessions))for(const[m,h]of d.times)a.push({channelName:S,channelUrl:d.url,startTime:m*1e3,endTime:h*1e3,windowId:0})}c.setDate(c.getDate()+1)}return{sessions:o,youtubeSessions:a}}async function M(t,e){const n=(await chrome.storage.local.get(i.DAILY_STATS))[i.DAILY_STATS]||{};n[t]=e,await chrome.storage.local.set({[i.DAILY_STATS]:n})}async function q(t){const e=f(),s=await O(e);s.blockedAttempts++,await M(e,s)}function T(t,e=!1){if(t.length===0)return{merged:[],totalSeconds:0};const s=[...t].sort((c,r)=>c.start-r.start),n=[s[0]];for(let c=1;c<s.length;c++){const r=s[c],l=n[n.length-1];r.start<=l.end?l.end=Math.max(l.end,r.end):n.push(r)}const o=e?1:1e3,a=n.reduce((c,r)=>c+Math.round((r.end-r.start)/o),0);return{merged:n,totalSeconds:a}}function B(t){const e={},s=[];for(const[o,a]of Object.entries(t)){const c=a.map(([l,u])=>({start:l,end:u}));s.push(...c);const{totalSeconds:r}=T(c,!0);e[o]=r}const{totalSeconds:n}=T(s,!0);return{totalTime:n,sites:e}}async function z(t){const e=new Date(t.startTime),s=f(e),o=(await chrome.storage.local.get(i.DAILY_STATS))[i.DAILY_STATS]||{},a=o[s]||{date:s,totalTime:0,sites:{},visits:0,blockedAttempts:0,sessions:{},youtubeSessions:{}};(!a.sessions||Array.isArray(a.sessions))&&(a.sessions={});const c=t.domain,r=Math.floor(t.startTime/1e3),l=Math.floor(t.endTime/1e3);a.sessions[c]||(a.sessions[c]=[]),a.sessions[c].push([r,l]),a.visits++;const u=B(a.sessions);a.totalTime=u.totalTime,a.sites=u.sites,a.youtubeSessions||(a.youtubeSessions={}),o[s]=a,await chrome.storage.local.set({[i.DAILY_STATS]:o})}function J(t){const e={};for(const[s,n]of Object.entries(t)){const o=n.times.map(([c,r])=>({start:c,end:r})),{totalSeconds:a}=T(o,!0);e[s]={time:a,url:n.url}}return e}function Q(t){const e=new Map,s=new Map;for(const o of t){const a=o.channelName,c=e.get(a)||[];c.push({start:o.startTime,end:o.endTime}),e.set(a,c),o.channelUrl&&s.set(a,o.channelUrl)}const n={};for(const[o,a]of e){const{totalSeconds:c}=T(a);n[o]={time:c,url:s.get(o)}}return n}async function X(t){const e=new Date(t.startTime),s=f(e),o=(await chrome.storage.local.get(i.DAILY_STATS))[i.DAILY_STATS]||{},a=o[s]||{date:s,totalTime:0,sites:{},visits:0,blockedAttempts:0,sessions:{},youtubeSessions:{}};(!a.youtubeSessions||Array.isArray(a.youtubeSessions))&&(a.youtubeSessions={});const c=t.channelName,r=Math.floor(t.startTime/1e3),l=Math.floor(t.endTime/1e3);a.youtubeSessions[c]||(a.youtubeSessions[c]={times:[]}),a.youtubeSessions[c].times.push([r,l]),t.channelUrl&&(a.youtubeSessions[c].url=t.channelUrl),o[s]=a,await chrome.storage.local.set({[i.DAILY_STATS]:o})}async function b(){return(await chrome.storage.local.get(i.ACTIVE_YOUTUBE_SESSIONS))[i.ACTIVE_YOUTUBE_SESSIONS]||{}}async function C(t){await chrome.storage.local.set({[i.ACTIVE_YOUTUBE_SESSIONS]:t})}async function Z(t,e){const s=await b();s[t]=e,await C(s)}async function tt(t){const e=await b(),s=e[t];return s&&(delete e[t],await C(e)),s}async function st(){await chrome.storage.local.remove(i.ACTIVE_YOUTUBE_SESSIONS)}async function L(){return(await chrome.storage.local.get(i.ACTIVE_SESSIONS))[i.ACTIVE_SESSIONS]||{}}async function Y(t){await chrome.storage.local.set({[i.ACTIVE_SESSIONS]:t})}async function et(t,e){const s=await L();s[t]=e,await Y(s)}async function at(t){const e=await L(),s=e[t];return s&&(delete e[t],await Y(e)),s}async function ot(){await chrome.storage.local.remove(i.ACTIVE_SESSIONS)}async function R(t){const s=new TextEncoder().encode(t),n=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(n)).map(a=>a.toString(16).padStart(2,"0")).join("")}async function nt(t,e){return await R(t)===e}function it(t,e){try{const s=new URL(t),n=s.hostname,o=s.pathname,a=e.includes("/");let c,r=null;if(a){const u=e.indexOf("/");c=e.slice(0,u),r=e.slice(u),r.endsWith("/*")&&(r=r.slice(0,-2))}else c=e;let l=!1;if(c.startsWith("*.")){const u=c.slice(2);l=n===u||n.endsWith("."+u)}else l=n===c||n==="www."+c;return l?r?o===r||o.startsWith(r+"/"):!0:!1}catch{return!1}}async function U(){return(await chrome.storage.local.get(i.DOMAIN_CATEGORIES))[i.DOMAIN_CATEGORIES]||{}}async function ct(t,e){const s=await U();e===null?delete s[t]:s[t]=e,await chrome.storage.local.set({[i.DOMAIN_CATEGORIES]:s})}async function D(){return(await chrome.storage.local.get(i.CUSTOM_CATEGORIES))[i.CUSTOM_CATEGORIES]||[]}async function _(t){await chrome.storage.local.set({[i.CUSTOM_CATEGORIES]:t})}async function rt(t){const e=await D(),s={...t,id:crypto.randomUUID()};return e.push(s),await _(e),s}async function lt(t){const e=await D(),s=e.findIndex(n=>n.id===t.id);s!==-1&&(e[s]=t,await _(e))}async function ut(t){const s=(await D()).filter(a=>a.id!==t);await _(s);const n=await U(),o={};for(const[a,c]of Object.entries(n))c!==t&&(o[a]=c);await chrome.storage.local.set({[i.DOMAIN_CATEGORIES]:o})}async function k(){return(await chrome.storage.local.get(i.BUILTIN_CATEGORY_OVERRIDES))[i.BUILTIN_CATEGORY_OVERRIDES]||{}}async function St(t,e){const s=await k();e===null?delete s[t]:s[t]=e,await chrome.storage.local.set({[i.BUILTIN_CATEGORY_OVERRIDES]:s})}async function A(){return(await chrome.storage.local.get(i.DAILY_LIMITS))[i.DAILY_LIMITS]||[]}async function p(t){await chrome.storage.local.set({[i.DAILY_LIMITS]:t})}async function dt(t){const e=await A(),s={...t,id:crypto.randomUUID()};return e.push(s),await p(e),s}async function mt(t){const e=await A(),s=e.findIndex(n=>n.id===t.id);s!==-1&&(e[s]=t,await p(e))}async function ft(t){const s=(await A()).filter(n=>n.id!==t);await p(s)}async function Tt(t){const e=await A(),s=f(),n=await O(s);for(const o of e){if(!o.enabled||o.bypassedUntil&&Date.now()<o.bypassedUntil)continue;const a=t.replace(/^www\./,""),c=o.pattern.replace(/^www\./,"");let r=!1;if(c.startsWith("*.")){const l=c.slice(2);r=a===l||a.endsWith("."+l)}else r=a===c;if(r){const l=n.sites[t]||n.sites["www."+t]||n.sites[a]||0,u=Math.max(0,o.limitSeconds-l);return{exceeded:l>=o.limitSeconds,limit:o,timeSpent:l,remaining:u}}}return{exceeded:!1,timeSpent:0,remaining:1/0}}const w="sessionFormatMigrated";async function yt(){if((await chrome.storage.local.get(w))[w])return!1;console.log("[Migration] Starting session format migration...");const s=(await chrome.storage.local.get(i.DAILY_STATS))[i.DAILY_STATS]||{};let n=0;for(const o of Object.values(s)){const a=o;let c=!1;if(Array.isArray(a.sessions)){const r=a.sessions,l={};for(const u of r){const S=u.domain,d=Math.floor(u.startTime/1e3),m=Math.floor(u.endTime/1e3);l[S]||(l[S]=[]),l[S].push([d,m])}a.sessions=l,c=!0}if(Array.isArray(a.youtubeSessions)){const r=a.youtubeSessions,l={};for(const u of r){const S=u.channelName,d=Math.floor(u.startTime/1e3),m=Math.floor(u.endTime/1e3);l[S]||(l[S]={times:[]}),l[S].times.push([d,m]),u.channelUrl&&(l[S].url=u.channelUrl)}a.youtubeSessions=l,c=!0}c&&n++}return await chrome.storage.local.set({[i.DAILY_STATS]:s,[w]:!0}),console.log(`[Migration] Completed. Migrated ${n} days of data.`),!0}export{V as A,q as B,W as C,y as D,g as E,x as F,F as G,G as H,$ as I,H as J,O as K,P as L,z as M,et as N,Z as O,tt as P,X as Q,st as R,it as S,at as T,ot as U,Q as a,L as b,J as c,b as d,Tt as e,dt as f,N as g,R as h,A as i,k as j,ut as k,_ as l,yt as m,lt as n,rt as o,D as p,ct as q,ft as r,St as s,U as t,mt as u,nt as v,I as w,j as x,K as y,E as z};
