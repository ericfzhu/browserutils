const N={trackingEnabled:!0,blockingEnabled:!0,youtubeTrackingEnabled:!1,theme:"system",retentionDays:30,idleThreshold:60,displayName:"",quickLinks:[]};function f(t=new Date){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function b(t,s){if(s<=t)return[];const e=[];let a=t;for(;a<s;){const n=new Date(a),o=new Date(n.getFullYear(),n.getMonth(),n.getDate()).getTime()+24*60*60*1e3,r=Math.min(s,o),l=Math.floor(a/1e3),u=Math.floor(r/1e3);u>l&&e.push({date:f(n),startSec:l,endSec:u}),a=r}return e}function O(t){const[s,e]=t.split(":").map(Number);return!Number.isInteger(s)||!Number.isInteger(e)||s<0||s>23||e<0||e>59?null:s*60+e}function x(t,s=new Date){if(!t||t.days.length===0)return!1;const e=O(t.startTime),a=O(t.endTime);if(e===null||a===null)return!1;const n=s.getHours()*60+s.getMinutes(),i=s.getDay(),o=(i+6)%7;return e===a?t.days.includes(i):e<a?t.days.includes(i)&&n>=e&&n<=a:t.days.includes(i)&&n>=e||t.days.includes(o)&&n<=a}const c={BLOCKED_SITES:"blockedSites",BLOCKED_SITE_FOLDERS:"blockedSiteFolders",SETTINGS:"settings",DAILY_STATS:"dailyStats",ACTIVE_SESSIONS:"activeSessions",ACTIVE_YOUTUBE_SESSIONS:"activeYouTubeSessions",DOMAIN_CATEGORIES:"domainCategories",DAILY_LIMITS:"dailyLimits",CUSTOM_CATEGORIES:"customCategories",BUILTIN_CATEGORY_OVERRIDES:"builtInCategoryOverrides"};async function g(){return(await chrome.storage.local.get(c.BLOCKED_SITES))[c.BLOCKED_SITES]||[]}async function T(t){await chrome.storage.local.set({[c.BLOCKED_SITES]:t})}async function j(t){const s=await g(),e={...t,id:crypto.randomUUID(),createdAt:Date.now()};return s.push(e),await T(s),e}async function V(t){const e=(await g()).filter(a=>a.id!==t);await T(e)}async function K(t){const s=await g(),e=s.findIndex(a=>a.id===t.id);e!==-1&&(s[e]=t,await T(s))}async function I(){return(await chrome.storage.local.get(c.BLOCKED_SITE_FOLDERS))[c.BLOCKED_SITE_FOLDERS]||[]}async function D(t){await chrome.storage.local.set({[c.BLOCKED_SITE_FOLDERS]:t})}async function W(t){const s=await I(),e={...t,id:crypto.randomUUID()};return s.push(e),await D(s),e}async function H(t){const s=await I(),e=s.findIndex(a=>a.id===t.id);e!==-1&&(s[e]=t,await D(s))}async function P(t){const e=(await I()).filter(i=>i.id!==t);await D(e);const n=(await g()).map(i=>i.folderId===t?{...i,folderId:void 0}:i);await T(n)}async function B(){const t=await chrome.storage.local.get(c.SETTINGS);return{...N,...t[c.SETTINGS]}}async function $(t){const e={...await B(),...t};return await chrome.storage.local.set({[c.SETTINGS]:e}),e}async function L(t){const s=t||f(),n=((await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{})[s];return n?((!n.sessions||Array.isArray(n.sessions))&&(n.sessions={}),(!n.youtubeSessions||Array.isArray(n.youtubeSessions))&&(n.youtubeSessions={}),n):{date:s,totalTime:0,sites:{},visits:0,blockedAttempts:0,sessions:{},youtubeSessions:{}}}async function q(){return(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{}}async function z(){const s=(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{},e={};for(const[a,n]of Object.entries(s))e[a]={date:n.date,totalTime:n.totalTime,sites:n.sites,visits:n.visits,blockedAttempts:n.blockedAttempts};return e}async function J(t,s){const a=(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{},n=[],i=[];let o=new Date(t+"T00:00:00");const r=new Date(s+"T00:00:00");for(;o<=r;){const l=f(o),u=a[l];if(u){if(u.sessions&&typeof u.sessions=="object"&&!Array.isArray(u.sessions))for(const[S,d]of Object.entries(u.sessions))for(const[m,A]of d)n.push({domain:S,startTime:m*1e3,endTime:A*1e3,windowId:0});if(u.youtubeSessions&&typeof u.youtubeSessions=="object"&&!Array.isArray(u.youtubeSessions))for(const[S,d]of Object.entries(u.youtubeSessions))for(const[m,A]of d.times)i.push({channelName:S,channelUrl:d.url,startTime:m*1e3,endTime:A*1e3,windowId:0})}o.setDate(o.getDate()+1)}return{sessions:n,youtubeSessions:i}}async function R(t,s){const a=(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{};a[t]=s,await chrome.storage.local.set({[c.DAILY_STATS]:a})}async function Q(t){const s=f(),e=await L(s);e.blockedAttempts++,await R(s,e)}function y(t,s=!1){if(t.length===0)return{merged:[],totalSeconds:0};const e=[...t].sort((o,r)=>o.start-r.start),a=[e[0]];for(let o=1;o<e.length;o++){const r=e[o],l=a[a.length-1];r.start<=l.end?l.end=Math.max(l.end,r.end):a.push(r)}const n=s?1:1e3,i=a.reduce((o,r)=>o+Math.round((r.end-r.start)/n),0);return{merged:a,totalSeconds:i}}function k(t){const s={},e=[];for(const[n,i]of Object.entries(t)){const o=i.map(([l,u])=>({start:l,end:u}));e.push(...o);const{totalSeconds:r}=y(o,!0);s[n]=r}const{totalSeconds:a}=y(e,!0);return{totalTime:a,sites:s}}async function X(t){const s=b(t.startTime,t.endTime);if(s.length===0)return;const a=(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{},n=t.domain;let i=!1;for(const o of s){const r=a[o.date]||{date:o.date,totalTime:0,sites:{},visits:0,blockedAttempts:0,sessions:{},youtubeSessions:{}};(!r.sessions||Array.isArray(r.sessions))&&(r.sessions={}),r.sessions[n]||(r.sessions[n]=[]),r.sessions[n].push([o.startSec,o.endSec]),i||(r.visits++,i=!0);const l=k(r.sessions);r.totalTime=l.totalTime,r.sites=l.sites,r.youtubeSessions||(r.youtubeSessions={}),a[o.date]=r}await chrome.storage.local.set({[c.DAILY_STATS]:a})}function Z(t){const s={};for(const[e,a]of Object.entries(t)){const n=a.times.map(([o,r])=>({start:o,end:r})),{totalSeconds:i}=y(n,!0);s[e]={time:i,url:a.url}}return s}function tt(t){const s=new Map,e=new Map;for(const n of t){const i=n.channelName,o=s.get(i)||[];o.push({start:n.startTime,end:n.endTime}),s.set(i,o),n.channelUrl&&e.set(i,n.channelUrl)}const a={};for(const[n,i]of s){const{totalSeconds:o}=y(i);a[n]={time:o,url:e.get(n)}}return a}async function st(t){const s=b(t.startTime,t.endTime);if(s.length===0)return;const a=(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{},n=t.channelName;for(const i of s){const o=a[i.date]||{date:i.date,totalTime:0,sites:{},visits:0,blockedAttempts:0,sessions:{},youtubeSessions:{}};(!o.youtubeSessions||Array.isArray(o.youtubeSessions))&&(o.youtubeSessions={}),o.youtubeSessions[n]||(o.youtubeSessions[n]={times:[]}),o.youtubeSessions[n].times.push([i.startSec,i.endSec]),t.channelUrl&&(o.youtubeSessions[n].url=t.channelUrl),a[i.date]=o}await chrome.storage.local.set({[c.DAILY_STATS]:a})}async function C(){return(await chrome.storage.local.get(c.ACTIVE_YOUTUBE_SESSIONS))[c.ACTIVE_YOUTUBE_SESSIONS]||{}}async function Y(t){await chrome.storage.local.set({[c.ACTIVE_YOUTUBE_SESSIONS]:t})}async function et(t,s){const e=await C();e[t]=s,await Y(e)}async function nt(t){const s=await C(),e=s[t];return e&&(delete s[t],await Y(s)),e}async function U(){return(await chrome.storage.local.get(c.ACTIVE_SESSIONS))[c.ACTIVE_SESSIONS]||{}}async function M(t){await chrome.storage.local.set({[c.ACTIVE_SESSIONS]:t})}async function at(t,s){const e=await U();e[t]=s,await M(e)}async function ot(t){const s=await U(),e=s[t];return e&&(delete s[t],await M(s)),e}async function G(t){const e=new TextEncoder().encode(t),a=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(a)).map(i=>i.toString(16).padStart(2,"0")).join("")}async function it(t,s){return await G(t)===s}function ct(t,s){try{const e=new URL(t),a=e.hostname,n=e.pathname,i=s.includes("/");let o,r=null;if(i){const u=s.indexOf("/");o=s.slice(0,u),r=s.slice(u),r.endsWith("/*")&&(r=r.slice(0,-2))}else o=s;let l=!1;if(o.startsWith("*.")){const u=o.slice(2);l=a===u||a.endsWith("."+u)}else l=a===o||a==="www."+o;return l?r?n===r||n.startsWith(r+"/"):!0:!1}catch{return!1}}async function v(){return(await chrome.storage.local.get(c.DOMAIN_CATEGORIES))[c.DOMAIN_CATEGORIES]||{}}async function rt(t,s){const e=await v();s===null?delete e[t]:e[t]=s,await chrome.storage.local.set({[c.DOMAIN_CATEGORIES]:e})}async function E(){return(await chrome.storage.local.get(c.CUSTOM_CATEGORIES))[c.CUSTOM_CATEGORIES]||[]}async function p(t){await chrome.storage.local.set({[c.CUSTOM_CATEGORIES]:t})}async function lt(t){const s=await E(),e={...t,id:crypto.randomUUID()};return s.push(e),await p(s),e}async function ut(t){const s=await E(),e=s.findIndex(a=>a.id===t.id);e!==-1&&(s[e]=t,await p(s))}async function St(t){const e=(await E()).filter(i=>i.id!==t);await p(e);const a=await v(),n={};for(const[i,o]of Object.entries(a))o!==t&&(n[i]=o);await chrome.storage.local.set({[c.DOMAIN_CATEGORIES]:n})}async function F(){return(await chrome.storage.local.get(c.BUILTIN_CATEGORY_OVERRIDES))[c.BUILTIN_CATEGORY_OVERRIDES]||{}}async function dt(t,s){const e=await F();s===null?delete e[t]:e[t]=s,await chrome.storage.local.set({[c.BUILTIN_CATEGORY_OVERRIDES]:e})}async function h(){return(await chrome.storage.local.get(c.DAILY_LIMITS))[c.DAILY_LIMITS]||[]}async function _(t){await chrome.storage.local.set({[c.DAILY_LIMITS]:t})}async function mt(t){const s=await h(),e={...t,id:crypto.randomUUID()};return s.push(e),await _(s),e}async function ft(t){const s=await h(),e=s.findIndex(a=>a.id===t.id);e!==-1&&(s[e]=t,await _(s))}async function yt(t){const e=(await h()).filter(a=>a.id!==t);await _(e)}async function gt(t){const s=await h(),e=f(),a=await L(e);for(const n of s){if(!n.enabled||n.bypassedUntil&&Date.now()<n.bypassedUntil)continue;const i=t.replace(/^www\./,""),o=n.pattern.replace(/^www\./,"");let r=!1;if(o.startsWith("*.")){const l=o.slice(2);r=i===l||i.endsWith("."+l)}else r=i===o;if(r){const l=a.sites[t]||a.sites["www."+t]||a.sites[i]||0,u=Math.max(0,n.limitSeconds-l);return{exceeded:l>=n.limitSeconds,limit:n,timeSpent:l,remaining:u}}}return{exceeded:!1,timeSpent:0,remaining:1/0}}const w="sessionFormatMigrated";async function Tt(){if((await chrome.storage.local.get(w))[w])return!1;console.log("[Migration] Starting session format migration...");const e=(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{};let a=0;for(const n of Object.values(e)){const i=n;let o=!1;if(Array.isArray(i.sessions)){const r=i.sessions,l={};for(const u of r){const S=u.domain,d=Math.floor(u.startTime/1e3),m=Math.floor(u.endTime/1e3);l[S]||(l[S]=[]),l[S].push([d,m])}i.sessions=l,o=!0}if(Array.isArray(i.youtubeSessions)){const r=i.youtubeSessions,l={};for(const u of r){const S=u.channelName,d=Math.floor(u.startTime/1e3),m=Math.floor(u.endTime/1e3);l[S]||(l[S]={times:[]}),l[S].times.push([d,m]),u.channelUrl&&(l[S].url=u.channelUrl)}i.youtubeSessions=l,o=!0}o&&a++}return await chrome.storage.local.set({[c.DAILY_STATS]:e,[w]:!0}),console.log(`[Migration] Completed. Migrated ${a} days of data.`),!0}export{W as A,Q as B,$ as C,g as D,T as E,K as F,V as G,j as H,J as I,z as J,L as K,q as L,X as M,at as N,et as O,nt as P,st as Q,ct as R,x as S,ot as T,tt as a,U as b,Z as c,C as d,gt as e,mt as f,B as g,G as h,h as i,F as j,St as k,p as l,Tt as m,ut as n,lt as o,E as p,rt as q,yt as r,dt as s,v as t,ft as u,it as v,I as w,H as x,P as y,D as z};
