const v={trackingEnabled:!0,blockingEnabled:!0,youtubeTrackingEnabled:!1,theme:"system",retentionDays:30,idleThreshold:60,displayName:"",quickLinks:[]},c={BLOCKED_SITES:"blockedSites",BLOCKED_SITE_FOLDERS:"blockedSiteFolders",SETTINGS:"settings",DAILY_STATS:"dailyStats",ACTIVE_SESSIONS:"activeSessions",ACTIVE_YOUTUBE_SESSIONS:"activeYouTubeSessions",DOMAIN_CATEGORIES:"domainCategories",DAILY_LIMITS:"dailyLimits",CUSTOM_CATEGORIES:"customCategories",BUILTIN_CATEGORY_OVERRIDES:"builtInCategoryOverrides"};async function y(){return(await chrome.storage.local.get(c.BLOCKED_SITES))[c.BLOCKED_SITES]||[]}async function g(t){await chrome.storage.local.set({[c.BLOCKED_SITES]:t})}async function G(t){const e=await y(),s={...t,id:crypto.randomUUID(),createdAt:Date.now()};return e.push(s),await g(e),s}async function F(t){const s=(await y()).filter(n=>n.id!==t);await g(s)}async function x(t){const e=await y(),s=e.findIndex(n=>n.id===t.id);s!==-1&&(e[s]=t,await g(e))}async function I(){return(await chrome.storage.local.get(c.BLOCKED_SITE_FOLDERS))[c.BLOCKED_SITE_FOLDERS]||[]}async function D(t){await chrome.storage.local.set({[c.BLOCKED_SITE_FOLDERS]:t})}async function j(t){const e=await I(),s={...t,id:crypto.randomUUID()};return e.push(s),await D(e),s}async function V(t){const e=await I(),s=e.findIndex(n=>n.id===t.id);s!==-1&&(e[s]=t,await D(e))}async function K(t){const s=(await I()).filter(a=>a.id!==t);await D(s);const o=(await y()).map(a=>a.folderId===t?{...a,folderId:void 0}:a);await g(o)}async function M(){const t=await chrome.storage.local.get(c.SETTINGS);return{...v,...t[c.SETTINGS]}}async function W(t){const s={...await M(),...t};return await chrome.storage.local.set({[c.SETTINGS]:s}),s}function f(t=new Date){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}async function O(t){const e=t||f(),o=((await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{})[e];return o?((!o.sessions||Array.isArray(o.sessions))&&(o.sessions={}),(!o.youtubeSessions||Array.isArray(o.youtubeSessions))&&(o.youtubeSessions={}),o):{date:e,totalTime:0,sites:{},visits:0,blockedAttempts:0,sessions:{},youtubeSessions:{}}}async function P(){return(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{}}async function H(){const e=(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{},s={};for(const[n,o]of Object.entries(e))s[n]={date:o.date,totalTime:o.totalTime,sites:o.sites,visits:o.visits,blockedAttempts:o.blockedAttempts};return s}async function $(t,e){const n=(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{},o=[],a=[];let i=new Date(t+"T00:00:00");const r=new Date(e+"T00:00:00");for(;i<=r;){const l=f(i),u=n[l];if(u){if(u.sessions&&typeof u.sessions=="object"&&!Array.isArray(u.sessions))for(const[S,d]of Object.entries(u.sessions))for(const[m,h]of d)o.push({domain:S,startTime:m*1e3,endTime:h*1e3,windowId:0});if(u.youtubeSessions&&typeof u.youtubeSessions=="object"&&!Array.isArray(u.youtubeSessions))for(const[S,d]of Object.entries(u.youtubeSessions))for(const[m,h]of d.times)a.push({channelName:S,channelUrl:d.url,startTime:m*1e3,endTime:h*1e3,windowId:0})}i.setDate(i.getDate()+1)}return{sessions:o,youtubeSessions:a}}async function N(t,e){const n=(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{};n[t]=e,await chrome.storage.local.set({[c.DAILY_STATS]:n})}async function q(t){const e=f(),s=await O(e);s.blockedAttempts++,await N(e,s)}function T(t,e=!1){if(t.length===0)return{merged:[],totalSeconds:0};const s=[...t].sort((i,r)=>i.start-r.start),n=[s[0]];for(let i=1;i<s.length;i++){const r=s[i],l=n[n.length-1];r.start<=l.end?l.end=Math.max(l.end,r.end):n.push(r)}const o=e?1:1e3,a=n.reduce((i,r)=>i+Math.round((r.end-r.start)/o),0);return{merged:n,totalSeconds:a}}function B(t){const e={},s=[];for(const[o,a]of Object.entries(t)){const i=a.map(([l,u])=>({start:l,end:u}));s.push(...i);const{totalSeconds:r}=T(i,!0);e[o]=r}const{totalSeconds:n}=T(s,!0);return{totalTime:n,sites:e}}async function z(t){const e=new Date(t.startTime),s=f(e),o=(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{},a=o[s]||{date:s,totalTime:0,sites:{},visits:0,blockedAttempts:0,sessions:{},youtubeSessions:{}};(!a.sessions||Array.isArray(a.sessions))&&(a.sessions={});const i=t.domain,r=Math.floor(t.startTime/1e3),l=Math.floor(t.endTime/1e3);a.sessions[i]||(a.sessions[i]=[]),a.sessions[i].push([r,l]),a.visits++;const u=B(a.sessions);a.totalTime=u.totalTime,a.sites=u.sites,a.youtubeSessions||(a.youtubeSessions={}),o[s]=a,await chrome.storage.local.set({[c.DAILY_STATS]:o})}function J(t){const e={};for(const[s,n]of Object.entries(t)){const o=n.times.map(([i,r])=>({start:i,end:r})),{totalSeconds:a}=T(o,!0);e[s]={time:a,url:n.url}}return e}function Q(t){const e=new Map,s=new Map;for(const o of t){const a=o.channelName,i=e.get(a)||[];i.push({start:o.startTime,end:o.endTime}),e.set(a,i),o.channelUrl&&s.set(a,o.channelUrl)}const n={};for(const[o,a]of e){const{totalSeconds:i}=T(a);n[o]={time:i,url:s.get(o)}}return n}async function X(t){const e=new Date(t.startTime),s=f(e),o=(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{},a=o[s]||{date:s,totalTime:0,sites:{},visits:0,blockedAttempts:0,sessions:{},youtubeSessions:{}};(!a.youtubeSessions||Array.isArray(a.youtubeSessions))&&(a.youtubeSessions={});const i=t.channelName,r=Math.floor(t.startTime/1e3),l=Math.floor(t.endTime/1e3);a.youtubeSessions[i]||(a.youtubeSessions[i]={times:[]}),a.youtubeSessions[i].times.push([r,l]),t.channelUrl&&(a.youtubeSessions[i].url=t.channelUrl),o[s]=a,await chrome.storage.local.set({[c.DAILY_STATS]:o})}async function b(){return(await chrome.storage.local.get(c.ACTIVE_YOUTUBE_SESSIONS))[c.ACTIVE_YOUTUBE_SESSIONS]||{}}async function L(t){await chrome.storage.local.set({[c.ACTIVE_YOUTUBE_SESSIONS]:t})}async function Z(t,e){const s=await b();s[t]=e,await L(s)}async function tt(t){const e=await b(),s=e[t];return s&&(delete e[t],await L(e)),s}async function C(){return(await chrome.storage.local.get(c.ACTIVE_SESSIONS))[c.ACTIVE_SESSIONS]||{}}async function Y(t){await chrome.storage.local.set({[c.ACTIVE_SESSIONS]:t})}async function st(t,e){const s=await C();s[t]=e,await Y(s)}async function et(t){const e=await C(),s=e[t];return s&&(delete e[t],await Y(e)),s}async function R(t){const s=new TextEncoder().encode(t),n=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(n)).map(a=>a.toString(16).padStart(2,"0")).join("")}async function at(t,e){return await R(t)===e}function ot(t,e){try{const s=new URL(t),n=s.hostname,o=s.pathname,a=e.includes("/");let i,r=null;if(a){const u=e.indexOf("/");i=e.slice(0,u),r=e.slice(u),r.endsWith("/*")&&(r=r.slice(0,-2))}else i=e;let l=!1;if(i.startsWith("*.")){const u=i.slice(2);l=n===u||n.endsWith("."+u)}else l=n===i||n==="www."+i;return l?r?o===r||o.startsWith(r+"/"):!0:!1}catch{return!1}}async function U(){return(await chrome.storage.local.get(c.DOMAIN_CATEGORIES))[c.DOMAIN_CATEGORIES]||{}}async function nt(t,e){const s=await U();e===null?delete s[t]:s[t]=e,await chrome.storage.local.set({[c.DOMAIN_CATEGORIES]:s})}async function E(){return(await chrome.storage.local.get(c.CUSTOM_CATEGORIES))[c.CUSTOM_CATEGORIES]||[]}async function _(t){await chrome.storage.local.set({[c.CUSTOM_CATEGORIES]:t})}async function it(t){const e=await E(),s={...t,id:crypto.randomUUID()};return e.push(s),await _(e),s}async function ct(t){const e=await E(),s=e.findIndex(n=>n.id===t.id);s!==-1&&(e[s]=t,await _(e))}async function rt(t){const s=(await E()).filter(a=>a.id!==t);await _(s);const n=await U(),o={};for(const[a,i]of Object.entries(n))i!==t&&(o[a]=i);await chrome.storage.local.set({[c.DOMAIN_CATEGORIES]:o})}async function k(){return(await chrome.storage.local.get(c.BUILTIN_CATEGORY_OVERRIDES))[c.BUILTIN_CATEGORY_OVERRIDES]||{}}async function lt(t,e){const s=await k();e===null?delete s[t]:s[t]=e,await chrome.storage.local.set({[c.BUILTIN_CATEGORY_OVERRIDES]:s})}async function A(){return(await chrome.storage.local.get(c.DAILY_LIMITS))[c.DAILY_LIMITS]||[]}async function p(t){await chrome.storage.local.set({[c.DAILY_LIMITS]:t})}async function ut(t){const e=await A(),s={...t,id:crypto.randomUUID()};return e.push(s),await p(e),s}async function St(t){const e=await A(),s=e.findIndex(n=>n.id===t.id);s!==-1&&(e[s]=t,await p(e))}async function dt(t){const s=(await A()).filter(n=>n.id!==t);await p(s)}async function mt(t){const e=await A(),s=f(),n=await O(s);for(const o of e){if(!o.enabled||o.bypassedUntil&&Date.now()<o.bypassedUntil)continue;const a=t.replace(/^www\./,""),i=o.pattern.replace(/^www\./,"");let r=!1;if(i.startsWith("*.")){const l=i.slice(2);r=a===l||a.endsWith("."+l)}else r=a===i;if(r){const l=n.sites[t]||n.sites["www."+t]||n.sites[a]||0,u=Math.max(0,o.limitSeconds-l);return{exceeded:l>=o.limitSeconds,limit:o,timeSpent:l,remaining:u}}}return{exceeded:!1,timeSpent:0,remaining:1/0}}const w="sessionFormatMigrated";async function ft(){if((await chrome.storage.local.get(w))[w])return!1;console.log("[Migration] Starting session format migration...");const s=(await chrome.storage.local.get(c.DAILY_STATS))[c.DAILY_STATS]||{};let n=0;for(const o of Object.values(s)){const a=o;let i=!1;if(Array.isArray(a.sessions)){const r=a.sessions,l={};for(const u of r){const S=u.domain,d=Math.floor(u.startTime/1e3),m=Math.floor(u.endTime/1e3);l[S]||(l[S]=[]),l[S].push([d,m])}a.sessions=l,i=!0}if(Array.isArray(a.youtubeSessions)){const r=a.youtubeSessions,l={};for(const u of r){const S=u.channelName,d=Math.floor(u.startTime/1e3),m=Math.floor(u.endTime/1e3);l[S]||(l[S]={times:[]}),l[S].times.push([d,m]),u.channelUrl&&(l[S].url=u.channelUrl)}a.youtubeSessions=l,i=!0}i&&n++}return await chrome.storage.local.set({[c.DAILY_STATS]:s,[w]:!0}),console.log(`[Migration] Completed. Migrated ${n} days of data.`),!0}export{j as A,q as B,W as C,y as D,g as E,x as F,F as G,G as H,$ as I,H as J,O as K,P as L,z as M,st as N,Z as O,tt as P,X as Q,ot as R,et as S,Q as a,C as b,J as c,b as d,mt as e,ut as f,M as g,R as h,A as i,k as j,rt as k,_ as l,ft as m,ct as n,it as o,E as p,nt as q,dt as r,lt as s,U as t,St as u,at as v,I as w,V as x,K as y,D as z};
